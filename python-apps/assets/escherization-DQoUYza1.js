import"./modulepreload-polyfill-B5Qt9EMX.js";import{r as f,j as t,c as it}from"./vendor-three-DWdYVK8p.js";import{u as Ke}from"./usePyodide-Bpngy5wJ.js";import"./vendor-react-CCYiWZgt.js";const st={simplifyRatio:.008,theta1:0,theta2:Math.PI/2,alphaThreshold:128,grayscaleThreshold:250,maxDimension:2048,timeoutMs:9e4};async function ge(i){const n=await createImageBitmap(i);return Pe(n)}function Pe(i){const n=document.createElement("canvas");n.width=i.width,n.height=i.height;const r=n.getContext("2d",{willReadFrequently:!0});if(!r)throw new Error("Failed to get 2D context");return r.drawImage(i,0,0),r.getImageData(0,0,i.width,i.height)}let oe=null,at=1;const Se=new Map;function ot(){if(oe)return oe;const i=new Worker(new URL("/my-site/python-apps/assets/prepareContourWorker-CBYGSW13.js",import.meta.url),{type:"module"});return i.onmessage=n=>{const r=n.data,e=Se.get(r.id);e&&(Se.delete(r.id),r.type==="error"?e.reject(new Error(r.message)):e.resolve(r))},i.onerror=n=>{console.error("prepareContourWorker error",n)},oe=i,oe}function lt(){oe&&oe.terminate(),oe=null}async function me(i,n={}){const r={...st,...n},e=at++,s=ot(),l=i.width,u=i.height,v=new Uint8ClampedArray(i.data).buffer,P={id:e,type:"process",width:l,height:u,buffer:v,options:{simplifyRatio:r.simplifyRatio,theta1:r.theta1,theta2:r.theta2,alphaThreshold:r.alphaThreshold,grayscaleThreshold:r.grayscaleThreshold,maxDimension:r.maxDimension}},g=new Promise((b,R)=>{Se.set(e,{resolve:b,reject:R}),s.postMessage(P,[v])}),x=new Promise((b,R)=>{const E=window.setTimeout(()=>{lt(),R(new Error(`prepareContourForEscherization timed out after ${r.timeoutMs}ms`))},r.timeoutMs);g.finally(()=>window.clearTimeout(E))}),h=await Promise.race([g,x]);if(h.type!=="result")throw new Error("Unexpected worker response");return{contour:ct(h.contour),imageData:i,tranU:h.tranU,tranV:h.tranV}}function ct(i){return ut(i)<0?i.slice().reverse():i.slice()}function ut(i){let n=0;const r=i.length;for(let e=0;e<r;e++){const s=(e+1)%r;n+=i[e][0]*i[s][1]-i[s][0]*i[e][1]}return n}function ht(){const[i,n]=f.useState(null),[r,e]=f.useState(.008),[s,l]=f.useState(0),[u,d]=f.useState(90),[v,P]=f.useState(9e4),[g,x]=f.useState(null),[h,C]=f.useState(null),[b,R]=f.useState(!1),E=f.useRef(null),y=f.useMemo(()=>s*Math.PI/180,[s]),_=f.useMemo(()=>u*Math.PI/180,[u]),Y=f.useCallback(T=>{const S=E.current;if(!S)return;const N=S.getContext("2d");if(!N)return;S.width=T.imageData.width,S.height=T.imageData.height,N.putImageData(T.imageData,0,0);const z=T.contour;if(!(z.length<2)){N.save(),N.lineWidth=Math.max(1,Math.floor(Math.min(S.width,S.height)/400)),N.strokeStyle="rgba(255, 0, 0, 0.9)",N.beginPath(),N.moveTo(z[0][0],z[0][1]);for(let F=1;F<z.length;F++)N.lineTo(z[F][0],z[F][1]);N.closePath(),N.stroke(),N.restore()}},[]),V=f.useCallback(async()=>{if(i){R(!0),C(null),x(null);try{const T=await ge(i);console.log("Loaded image:",T.width,"x",T.height);const S=await me(T,{simplifyRatio:r,theta1:y,theta2:_,timeoutMs:v});console.log("Prepared contour:",S),x(S),Y(S)}catch(T){console.error("Contour prep failed:",T),C(T instanceof Error?T.message:String(T))}finally{R(!1)}}},[Y,i,r,y,_,v]);return t.jsxs("section",{children:[t.jsx("h2",{children:"prepare_contour_for_escherization (Test)"}),t.jsx("p",{children:"画像から輪郭抽出→CCW統一→平行四辺形ベクトル算出（Web Worker + d3-contour使用）"}),t.jsxs("div",{className:"escher-controls",children:[t.jsxs("label",{className:"control",children:[t.jsx("span",{children:"画像ファイル"}),t.jsx("input",{type:"file",accept:"image/*",onChange:T=>n(T.target.files?.[0]??null)})]}),t.jsxs("div",{className:"controls-row",children:[t.jsxs("label",{className:"control",children:[t.jsx("span",{children:"simplifyRatio"}),t.jsx("input",{type:"number",step:"0.001",min:"0",value:r,onChange:T=>e(Number(T.target.value))})]}),t.jsxs("label",{className:"control",children:[t.jsx("span",{children:"theta1 (deg)"}),t.jsx("input",{type:"number",step:"1",value:s,onChange:T=>l(Number(T.target.value))})]}),t.jsxs("label",{className:"control",children:[t.jsx("span",{children:"theta2 (deg)"}),t.jsx("input",{type:"number",step:"1",value:u,onChange:T=>d(Number(T.target.value))})]}),t.jsxs("label",{className:"control",children:[t.jsx("span",{children:"timeout (ms)"}),t.jsx("input",{type:"number",step:"1000",min:"1000",value:v,onChange:T=>P(Number(T.target.value))})]}),t.jsx("button",{className:"run-button",onClick:V,disabled:!i||b,children:b?"処理中...":"実行"})]}),h&&t.jsxs("div",{className:"error",children:["エラー: ",h]})]}),t.jsxs("div",{className:"escher-output",children:[t.jsx("div",{className:"canvas-wrap",children:t.jsx("canvas",{ref:E})}),t.jsxs("div",{className:"stats",children:[t.jsx("h3",{children:"結果"}),g?t.jsxs("dl",{children:[t.jsxs("div",{className:"kv",children:[t.jsx("dt",{children:"contour points"}),t.jsx("dd",{children:g.contour.length})]}),t.jsxs("div",{className:"kv",children:[t.jsx("dt",{children:"image size"}),t.jsxs("dd",{children:[g.imageData.width," × ",g.imageData.height]})]}),t.jsxs("div",{className:"kv",children:[t.jsx("dt",{children:"tran_u"}),t.jsxs("dd",{children:["(",g.tranU[0].toFixed(2),", ",g.tranU[1].toFixed(2),")"]})]}),t.jsxs("div",{className:"kv",children:[t.jsx("dt",{children:"tran_v"}),t.jsxs("dd",{children:["(",g.tranV[0].toFixed(2),", ",g.tranV[1].toFixed(2),")"]})]})]}):t.jsx("p",{children:"画像を選んで「実行」を押してください。"})]})]})]})}var xe={};const dt="1.5.0",ft={version:dt};var ve,We;function Ee(){if(We)return ve;We=1;function i(s){return"("+s.x+";"+s.y+")"}function n(s){var l=s.toString();return l==="[object Object]"?i(s):l}function r(s,l){return s.y===l.y?s.x-l.x:s.y-l.y}function e(s,l){return s.x===l.x&&s.y===l.y}return ve={toString:n,toStringBase:i,compare:r,equals:e},ve}var ye,Re;function Te(){if(Re)return ye;Re=1;var i=Ee(),n=function(r,e){this.name="PointError",this.points=e=e||[],this.message=r||"Invalid Points!";for(var s=0;s<e.length;s++)this.message+=" "+i.toString(e[s])};return n.prototype=new Error,n.prototype.constructor=n,ye=n,ye}var be,ze;function Ze(){if(ze)return be;ze=1;var i=Ee(),n=function(r,e){this.x=+r||0,this.y=+e||0,this._p2t_edge_list=null};return n.prototype.toString=function(){return i.toStringBase(this)},n.prototype.toJSON=function(){return{x:this.x,y:this.y}},n.prototype.clone=function(){return new n(this.x,this.y)},n.prototype.set_zero=function(){return this.x=0,this.y=0,this},n.prototype.set=function(r,e){return this.x=+r||0,this.y=+e||0,this},n.prototype.negate=function(){return this.x=-this.x,this.y=-this.y,this},n.prototype.add=function(r){return this.x+=r.x,this.y+=r.y,this},n.prototype.sub=function(r){return this.x-=r.x,this.y-=r.y,this},n.prototype.mul=function(r){return this.x*=r,this.y*=r,this},n.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},n.prototype.normalize=function(){var r=this.length();return this.x/=r,this.y/=r,r},n.prototype.equals=function(r){return this.x===r.x&&this.y===r.y},n.negate=function(r){return new n(-r.x,-r.y)},n.add=function(r,e){return new n(r.x+e.x,r.y+e.y)},n.sub=function(r,e){return new n(r.x-e.x,r.y-e.y)},n.mul=function(r,e){return new n(r*e.x,r*e.y)},n.cross=function(r,e){return typeof r=="number"?typeof e=="number"?r*e:new n(-r*e.y,r*e.x):typeof e=="number"?new n(e*r.y,-e*r.x):r.x*e.y-r.y*e.x},n.toString=i.toString,n.compare=i.compare,n.cmp=i.compare,n.equals=i.equals,n.dot=function(r,e){return r.x*e.x+r.y*e.y},be=n,be}var _e,De;function Ae(){if(De)return _e;De=1;var i=Ee(),n=function(e,s,l){this.points_=[e,s,l],this.neighbors_=[null,null,null],this.interior_=!1,this.constrained_edge=[!1,!1,!1],this.delaunay_edge=[!1,!1,!1]},r=i.toString;return n.prototype.toString=function(){return"["+r(this.points_[0])+r(this.points_[1])+r(this.points_[2])+"]"},n.prototype.getPoint=function(e){return this.points_[e]},n.prototype.GetPoint=n.prototype.getPoint,n.prototype.getPoints=function(){return this.points_},n.prototype.getNeighbor=function(e){return this.neighbors_[e]},n.prototype.containsPoint=function(e){var s=this.points_;return e===s[0]||e===s[1]||e===s[2]},n.prototype.containsEdge=function(e){return this.containsPoint(e.p)&&this.containsPoint(e.q)},n.prototype.containsPoints=function(e,s){return this.containsPoint(e)&&this.containsPoint(s)},n.prototype.isInterior=function(){return this.interior_},n.prototype.setInterior=function(e){return this.interior_=e,this},n.prototype.markNeighborPointers=function(e,s,l){var u=this.points_;if(e===u[2]&&s===u[1]||e===u[1]&&s===u[2])this.neighbors_[0]=l;else if(e===u[0]&&s===u[2]||e===u[2]&&s===u[0])this.neighbors_[1]=l;else if(e===u[0]&&s===u[1]||e===u[1]&&s===u[0])this.neighbors_[2]=l;else throw new Error("poly2tri Invalid Triangle.markNeighborPointers() call")},n.prototype.markNeighbor=function(e){var s=this.points_;e.containsPoints(s[1],s[2])?(this.neighbors_[0]=e,e.markNeighborPointers(s[1],s[2],this)):e.containsPoints(s[0],s[2])?(this.neighbors_[1]=e,e.markNeighborPointers(s[0],s[2],this)):e.containsPoints(s[0],s[1])&&(this.neighbors_[2]=e,e.markNeighborPointers(s[0],s[1],this))},n.prototype.clearNeighbors=function(){this.neighbors_[0]=null,this.neighbors_[1]=null,this.neighbors_[2]=null},n.prototype.clearDelaunayEdges=function(){this.delaunay_edge[0]=!1,this.delaunay_edge[1]=!1,this.delaunay_edge[2]=!1},n.prototype.pointCW=function(e){var s=this.points_;return e===s[0]?s[2]:e===s[1]?s[0]:e===s[2]?s[1]:null},n.prototype.pointCCW=function(e){var s=this.points_;return e===s[0]?s[1]:e===s[1]?s[2]:e===s[2]?s[0]:null},n.prototype.neighborCW=function(e){return e===this.points_[0]?this.neighbors_[1]:e===this.points_[1]?this.neighbors_[2]:this.neighbors_[0]},n.prototype.neighborCCW=function(e){return e===this.points_[0]?this.neighbors_[2]:e===this.points_[1]?this.neighbors_[0]:this.neighbors_[1]},n.prototype.getConstrainedEdgeCW=function(e){return e===this.points_[0]?this.constrained_edge[1]:e===this.points_[1]?this.constrained_edge[2]:this.constrained_edge[0]},n.prototype.getConstrainedEdgeCCW=function(e){return e===this.points_[0]?this.constrained_edge[2]:e===this.points_[1]?this.constrained_edge[0]:this.constrained_edge[1]},n.prototype.getConstrainedEdgeAcross=function(e){return e===this.points_[0]?this.constrained_edge[0]:e===this.points_[1]?this.constrained_edge[1]:this.constrained_edge[2]},n.prototype.setConstrainedEdgeCW=function(e,s){e===this.points_[0]?this.constrained_edge[1]=s:e===this.points_[1]?this.constrained_edge[2]=s:this.constrained_edge[0]=s},n.prototype.setConstrainedEdgeCCW=function(e,s){e===this.points_[0]?this.constrained_edge[2]=s:e===this.points_[1]?this.constrained_edge[0]=s:this.constrained_edge[1]=s},n.prototype.getDelaunayEdgeCW=function(e){return e===this.points_[0]?this.delaunay_edge[1]:e===this.points_[1]?this.delaunay_edge[2]:this.delaunay_edge[0]},n.prototype.getDelaunayEdgeCCW=function(e){return e===this.points_[0]?this.delaunay_edge[2]:e===this.points_[1]?this.delaunay_edge[0]:this.delaunay_edge[1]},n.prototype.setDelaunayEdgeCW=function(e,s){e===this.points_[0]?this.delaunay_edge[1]=s:e===this.points_[1]?this.delaunay_edge[2]=s:this.delaunay_edge[0]=s},n.prototype.setDelaunayEdgeCCW=function(e,s){e===this.points_[0]?this.delaunay_edge[2]=s:e===this.points_[1]?this.delaunay_edge[0]=s:this.delaunay_edge[1]=s},n.prototype.neighborAcross=function(e){return e===this.points_[0]?this.neighbors_[0]:e===this.points_[1]?this.neighbors_[1]:this.neighbors_[2]},n.prototype.oppositePoint=function(e,s){var l=e.pointCW(s);return this.pointCW(l)},n.prototype.legalize=function(e,s){var l=this.points_;if(e===l[0])l[1]=l[0],l[0]=l[2],l[2]=s;else if(e===l[1])l[2]=l[1],l[1]=l[0],l[0]=s;else if(e===l[2])l[0]=l[2],l[2]=l[1],l[1]=s;else throw new Error("poly2tri Invalid Triangle.legalize() call")},n.prototype.index=function(e){var s=this.points_;if(e===s[0])return 0;if(e===s[1])return 1;if(e===s[2])return 2;throw new Error("poly2tri Invalid Triangle.index() call")},n.prototype.edgeIndex=function(e,s){var l=this.points_;if(e===l[0]){if(s===l[1])return 2;if(s===l[2])return 1}else if(e===l[1]){if(s===l[2])return 0;if(s===l[0])return 2}else if(e===l[2]){if(s===l[0])return 1;if(s===l[1])return 0}return-1},n.prototype.markConstrainedEdgeByIndex=function(e){this.constrained_edge[e]=!0},n.prototype.markConstrainedEdgeByEdge=function(e){this.markConstrainedEdgeByPoints(e.p,e.q)},n.prototype.markConstrainedEdgeByPoints=function(e,s){var l=this.points_;s===l[0]&&e===l[1]||s===l[1]&&e===l[0]?this.constrained_edge[2]=!0:s===l[0]&&e===l[2]||s===l[2]&&e===l[0]?this.constrained_edge[1]=!0:(s===l[1]&&e===l[2]||s===l[2]&&e===l[1])&&(this.constrained_edge[0]=!0)},_e=n,_e}var je={},Ce,Be;function pt(){if(Be)return Ce;Be=1;function i(n,r){if(!n)throw new Error(r||"Assert Failed")}return Ce=i,Ce}var pe={exports:{}},$e;function Qe(){if($e)return pe.exports;$e=1;var i=function(r,e){this.point=r,this.triangle=e||null,this.next=null,this.prev=null,this.value=r.x},n=function(r,e){this.head_=r,this.tail_=e,this.search_node_=r};return n.prototype.head=function(){return this.head_},n.prototype.setHead=function(r){this.head_=r},n.prototype.tail=function(){return this.tail_},n.prototype.setTail=function(r){this.tail_=r},n.prototype.search=function(){return this.search_node_},n.prototype.setSearch=function(r){this.search_node_=r},n.prototype.findSearchNode=function(){return this.search_node_},n.prototype.locateNode=function(r){var e=this.search_node_;if(r<e.value){for(;e=e.prev;)if(r>=e.value)return this.search_node_=e,e}else for(;e=e.next;)if(r<e.value)return this.search_node_=e.prev,e.prev;return null},n.prototype.locatePoint=function(r){var e=r.x,s=this.findSearchNode(e),l=s.point.x;if(e===l){if(r!==s.point)if(r===s.prev.point)s=s.prev;else if(r===s.next.point)s=s.next;else throw new Error("poly2tri Invalid AdvancingFront.locatePoint() call")}else if(e<l)for(;(s=s.prev)&&r!==s.point;);else for(;(s=s.next)&&r!==s.point;);return s&&(this.search_node_=s),s},pe.exports=n,pe.exports.Node=i,pe.exports}var ae={},Fe;function gt(){if(Fe)return ae;Fe=1;var i=1e-12;ae.EPSILON=i;var n={CW:1,CCW:-1,COLLINEAR:0};ae.Orientation=n;function r(l,u,d){var v=(l.x-d.x)*(u.y-d.y),P=(l.y-d.y)*(u.x-d.x),g=v-P;return g>-i&&g<i?n.COLLINEAR:g>0?n.CCW:n.CW}ae.orient2d=r;function e(l,u,d,v){var P=(l.x-u.x)*(v.y-u.y)-(v.x-u.x)*(l.y-u.y);if(P>=-i)return!1;var g=(l.x-d.x)*(v.y-d.y)-(v.x-d.x)*(l.y-d.y);return!(g<=i)}ae.inScanArea=e;function s(l,u,d){var v=u.x-l.x,P=u.y-l.y,g=d.x-l.x,x=d.y-l.y;return v*g+P*x<0}return ae.isAngleObtuse=s,ae}var Oe;function et(){if(Oe)return je;Oe=1;var i=pt(),n=Te(),r=Ae(),e=Qe().Node,s=gt(),l=s.EPSILON,u=s.Orientation,d=s.orient2d,v=s.inScanArea,P=s.isAngleObtuse;function g(c){c.initTriangulation(),c.createAdvancingFront(),x(c),h(c)}function x(c){var a,o=c.pointCount();for(a=1;a<o;++a)for(var p=c.getPoint(a),j=C(c,p),D=p._p2t_edge_list,I=0;D&&I<D.length;++I)b(c,D[I],j)}function h(c){for(var a=c.front().head().next.triangle,o=c.front().head().next.point;!a.getConstrainedEdgeCW(o);)a=a.neighborCCW(o);c.meshClean(a)}function C(c,a){var o=c.locateNode(a),p=y(c,a,o);return a.x<=o.point.x+l&&_(c,o),Y(c,p),p}function b(c,a,o){c.edge_event.constrained_edge=a,c.edge_event.right=a.p.x>a.q.x,!E(o.triangle,a.p,a.q)&&(U(c,a,o),R(c,a.p,a.q,o.triangle,a.q))}function R(c,a,o,p,j){if(!E(p,a,o)){var D=p.pointCCW(j),I=d(o,D,a);if(I===u.COLLINEAR)throw new n("poly2tri EdgeEvent: Collinear not supported!",[o,D,a]);var L=p.pointCW(j),w=d(o,L,a);if(w===u.COLLINEAR)throw new n("poly2tri EdgeEvent: Collinear not supported!",[o,L,a]);I===w?(I===u.CW?p=p.neighborCCW(j):p=p.neighborCW(j),R(c,a,o,p,j)):ne(c,a,o,p,j)}}function E(c,a,o){var p=c.edgeIndex(a,o);if(p!==-1){c.markConstrainedEdgeByIndex(p);var j=c.getNeighbor(p);return j&&j.markConstrainedEdgeByPoints(a,o),!0}return!1}function y(c,a,o){var p=new r(a,o.point,o.next.point);p.markNeighbor(o.triangle),c.addToMap(p);var j=new e(a);return j.next=o.next,j.prev=o,o.next.prev=j,o.next=j,T(c,p)||c.mapTriangleToNodes(p),j}function _(c,a){var o=new r(a.prev.point,a.point,a.next.point);o.markNeighbor(a.prev.triangle),o.markNeighbor(a.triangle),c.addToMap(o),a.prev.next=a.next,a.next.prev=a.prev,T(c,o)||c.mapTriangleToNodes(o)}function Y(c,a){for(var o=a.next;o.next&&!P(o.point,o.next.point,o.prev.point);)_(c,o),o=o.next;for(o=a.prev;o.prev&&!P(o.point,o.next.point,o.prev.point);)_(c,o),o=o.prev;a.next&&a.next.next&&V(a)&&z(c,a)}function V(c){var a=c.point.x-c.next.next.point.x,o=c.point.y-c.next.next.point.y;return i(o>=0,"unordered y"),a>=0||Math.abs(a)<o}function T(c,a){for(var o=0;o<3;++o)if(!a.delaunay_edge[o]){var p=a.getNeighbor(o);if(p){var j=a.getPoint(o),D=p.oppositePoint(a,j),I=p.index(D);if(p.constrained_edge[I]||p.delaunay_edge[I]){a.constrained_edge[o]=p.constrained_edge[I];continue}var L=S(j,a.pointCCW(j),a.pointCW(j),D);if(L){a.delaunay_edge[o]=!0,p.delaunay_edge[I]=!0,N(a,j,p,D);var w=!T(c,a);return w&&c.mapTriangleToNodes(a),w=!T(c,p),w&&c.mapTriangleToNodes(p),a.delaunay_edge[o]=!1,p.delaunay_edge[I]=!1,!0}}}return!1}function S(c,a,o,p){var j=c.x-p.x,D=c.y-p.y,I=a.x-p.x,L=a.y-p.y,w=j*L,X=I*D,m=w-X;if(m<=0)return!1;var W=o.x-p.x,$=o.y-p.y,B=W*D,M=j*$,Q=B-M;if(Q<=0)return!1;var ie=I*$,re=W*L,ce=j*j+D*D,ue=I*I+L*L,he=W*W+$*$,de=ce*(ie-re)+ue*Q+he*m;return de>0}function N(c,a,o,p){var j,D,I,L;j=c.neighborCCW(a),D=c.neighborCW(a),I=o.neighborCCW(p),L=o.neighborCW(p);var w,X,m,W;w=c.getConstrainedEdgeCCW(a),X=c.getConstrainedEdgeCW(a),m=o.getConstrainedEdgeCCW(p),W=o.getConstrainedEdgeCW(p);var $,B,M,Q;$=c.getDelaunayEdgeCCW(a),B=c.getDelaunayEdgeCW(a),M=o.getDelaunayEdgeCCW(p),Q=o.getDelaunayEdgeCW(p),c.legalize(a,p),o.legalize(p,a),o.setDelaunayEdgeCCW(a,$),c.setDelaunayEdgeCW(a,B),c.setDelaunayEdgeCCW(p,M),o.setDelaunayEdgeCW(p,Q),o.setConstrainedEdgeCCW(a,w),c.setConstrainedEdgeCW(a,X),c.setConstrainedEdgeCCW(p,m),o.setConstrainedEdgeCW(p,W),c.clearNeighbors(),o.clearNeighbors(),j&&o.markNeighbor(j),D&&c.markNeighbor(D),I&&c.markNeighbor(I),L&&o.markNeighbor(L),c.markNeighbor(o)}function z(c,a){for(d(a.point,a.next.point,a.next.next.point)===u.CCW?c.basin.left_node=a.next.next:c.basin.left_node=a.next,c.basin.bottom_node=c.basin.left_node;c.basin.bottom_node.next&&c.basin.bottom_node.point.y>=c.basin.bottom_node.next.point.y;)c.basin.bottom_node=c.basin.bottom_node.next;if(c.basin.bottom_node!==c.basin.left_node){for(c.basin.right_node=c.basin.bottom_node;c.basin.right_node.next&&c.basin.right_node.point.y<c.basin.right_node.next.point.y;)c.basin.right_node=c.basin.right_node.next;c.basin.right_node!==c.basin.bottom_node&&(c.basin.width=c.basin.right_node.point.x-c.basin.left_node.point.x,c.basin.left_highest=c.basin.left_node.point.y>c.basin.right_node.point.y,F(c,c.basin.bottom_node))}}function F(c,a){if(!k(c,a)){_(c,a);var o;if(!(a.prev===c.basin.left_node&&a.next===c.basin.right_node)){if(a.prev===c.basin.left_node){if(o=d(a.point,a.next.point,a.next.next.point),o===u.CW)return;a=a.next}else if(a.next===c.basin.right_node){if(o=d(a.point,a.prev.point,a.prev.prev.point),o===u.CCW)return;a=a.prev}else a.prev.point.y<a.next.point.y?a=a.prev:a=a.next;F(c,a)}}}function k(c,a){var o;return c.basin.left_highest?o=c.basin.left_node.point.y-a.point.y:o=c.basin.right_node.point.y-a.point.y,c.basin.width>o}function U(c,a,o){c.edge_event.right?q(c,a,o):ee(c,a,o)}function q(c,a,o){for(;o.next.point.x<a.p.x;)d(a.q,o.next.point,a.p)===u.CCW?H(c,a,o):o=o.next}function H(c,a,o){o.point.x<a.p.x&&(d(o.point,o.next.point,o.next.next.point)===u.CCW?Z(c,a,o):(O(c,a,o),H(c,a,o)))}function Z(c,a,o){_(c,o.next),o.next.point!==a.p&&d(a.q,o.next.point,a.p)===u.CCW&&d(o.point,o.next.point,o.next.next.point)===u.CCW&&Z(c,a,o)}function O(c,a,o){d(o.next.point,o.next.next.point,o.next.next.next.point)===u.CCW?Z(c,a,o.next):d(a.q,o.next.next.point,a.p)===u.CCW&&O(c,a,o.next)}function ee(c,a,o){for(;o.prev.point.x>a.p.x;)d(a.q,o.prev.point,a.p)===u.CW?J(c,a,o):o=o.prev}function J(c,a,o){o.point.x>a.p.x&&(d(o.point,o.prev.point,o.prev.prev.point)===u.CW?A(c,a,o):(te(c,a,o),J(c,a,o)))}function te(c,a,o){d(o.prev.point,o.prev.prev.point,o.prev.prev.prev.point)===u.CW?A(c,a,o.prev):d(a.q,o.prev.prev.point,a.p)===u.CW&&te(c,a,o.prev)}function A(c,a,o){_(c,o.prev),o.prev.point!==a.p&&d(a.q,o.prev.point,a.p)===u.CW&&d(o.point,o.prev.point,o.prev.prev.point)===u.CW&&A(c,a,o)}function ne(c,a,o,p,j){var D=p.neighborAcross(j);i(D,"FLIP failed due to missing triangle!");var I=D.oppositePoint(p,j);if(p.getConstrainedEdgeAcross(j)){var L=p.index(j);throw new n("poly2tri Intersecting Constraints",[j,I,p.getPoint((L+1)%3),p.getPoint((L+2)%3)])}if(v(j,p.pointCCW(j),p.pointCW(j),I))if(N(p,j,D,I),c.mapTriangleToNodes(p),c.mapTriangleToNodes(D),j===o&&I===a)o===c.edge_event.constrained_edge.q&&a===c.edge_event.constrained_edge.p&&(p.markConstrainedEdgeByPoints(a,o),D.markConstrainedEdgeByPoints(a,o),T(c,p),T(c,D));else{var w=d(o,I,a);p=G(c,w,p,D,j,I),ne(c,a,o,p,j)}else{var X=se(a,o,D,I);K(c,a,o,p,D,X),R(c,a,o,p,j)}}function G(c,a,o,p,j,D){var I;return a===u.CCW?(I=p.edgeIndex(j,D),p.delaunay_edge[I]=!0,T(c,p),p.clearDelaunayEdges(),o):(I=o.edgeIndex(j,D),o.delaunay_edge[I]=!0,T(c,o),o.clearDelaunayEdges(),p)}function se(c,a,o,p){var j=d(a,p,c);if(j===u.CW)return o.pointCCW(p);if(j===u.CCW)return o.pointCW(p);throw new n("poly2tri [Unsupported] nextFlipPoint: opposing point on constrained edge!",[a,p,c])}function K(c,a,o,p,j,D){var I=j.neighborAcross(D);i(I,"FLIP failed due to missing triangle");var L=I.oppositePoint(j,D);if(v(o,p.pointCCW(o),p.pointCW(o),L))ne(c,o,L,I,L);else{var w=se(a,o,I,L);K(c,a,o,p,I,w)}}return je.triangulate=g,je}var we,Xe;function mt(){if(Xe)return we;Xe=1;var i=Te(),n=Ze(),r=Ae(),e=et(),s=Qe(),l=s.Node,u=.3,d=function(x,h){if(this.p=x,this.q=h,x.y>h.y)this.q=x,this.p=h;else if(x.y===h.y){if(x.x>h.x)this.q=x,this.p=h;else if(x.x===h.x)throw new i("poly2tri Invalid Edge constructor: repeated points!",[x])}this.q._p2t_edge_list||(this.q._p2t_edge_list=[]),this.q._p2t_edge_list.push(this)},v=function(){this.left_node=null,this.bottom_node=null,this.right_node=null,this.width=0,this.left_highest=!1};v.prototype.clear=function(){this.left_node=null,this.bottom_node=null,this.right_node=null,this.width=0,this.left_highest=!1};var P=function(){this.constrained_edge=null,this.right=!1},g=function(x,h){h=h||{},this.triangles_=[],this.map_=[],this.points_=h.cloneArrays?x.slice(0):x,this.edge_list=[],this.pmin_=this.pmax_=null,this.front_=null,this.head_=null,this.tail_=null,this.af_head_=null,this.af_middle_=null,this.af_tail_=null,this.basin=new v,this.edge_event=new P,this.initEdges(this.points_)};return g.prototype.addHole=function(x){this.initEdges(x);var h,C=x.length;for(h=0;h<C;h++)this.points_.push(x[h]);return this},g.prototype.AddHole=g.prototype.addHole,g.prototype.addHoles=function(x){var h,C=x.length;for(h=0;h<C;h++)this.initEdges(x[h]);return this.points_=this.points_.concat.apply(this.points_,x),this},g.prototype.addPoint=function(x){return this.points_.push(x),this},g.prototype.AddPoint=g.prototype.addPoint,g.prototype.addPoints=function(x){return this.points_=this.points_.concat(x),this},g.prototype.triangulate=function(){return e.triangulate(this),this},g.prototype.getBoundingBox=function(){return{min:this.pmin_,max:this.pmax_}},g.prototype.getTriangles=function(){return this.triangles_},g.prototype.GetTriangles=g.prototype.getTriangles,g.prototype.front=function(){return this.front_},g.prototype.pointCount=function(){return this.points_.length},g.prototype.head=function(){return this.head_},g.prototype.setHead=function(x){this.head_=x},g.prototype.tail=function(){return this.tail_},g.prototype.setTail=function(x){this.tail_=x},g.prototype.getMap=function(){return this.map_},g.prototype.initTriangulation=function(){var x=this.points_[0].x,h=this.points_[0].x,C=this.points_[0].y,b=this.points_[0].y,R,E=this.points_.length;for(R=1;R<E;R++){var y=this.points_[R];y.x>x&&(x=y.x),y.x<h&&(h=y.x),y.y>C&&(C=y.y),y.y<b&&(b=y.y)}this.pmin_=new n(h,b),this.pmax_=new n(x,C);var _=u*(x-h),Y=u*(C-b);this.head_=new n(x+_,b-Y),this.tail_=new n(h-_,b-Y),this.points_.sort(n.compare)},g.prototype.initEdges=function(x){var h,C=x.length;for(h=0;h<C;++h)this.edge_list.push(new d(x[h],x[(h+1)%C]))},g.prototype.getPoint=function(x){return this.points_[x]},g.prototype.addToMap=function(x){this.map_.push(x)},g.prototype.locateNode=function(x){return this.front_.locateNode(x.x)},g.prototype.createAdvancingFront=function(){var x,h,C,b=new r(this.points_[0],this.tail_,this.head_);this.map_.push(b),x=new l(b.getPoint(1),b),h=new l(b.getPoint(0),b),C=new l(b.getPoint(2)),this.front_=new s(x,C),x.next=h,h.next=C,h.prev=x,C.prev=h},g.prototype.removeNode=function(x){},g.prototype.mapTriangleToNodes=function(x){for(var h=0;h<3;++h)if(!x.getNeighbor(h)){var C=this.front_.locatePoint(x.pointCW(x.getPoint(h)));C&&(C.triangle=x)}},g.prototype.removeFromMap=function(x){var h,C=this.map_,b=C.length;for(h=0;h<b;h++)if(C[h]===x){C.splice(h,1);break}},g.prototype.meshClean=function(x){for(var h=[x],C,b;C=h.pop();)if(!C.isInterior())for(C.setInterior(!0),this.triangles_.push(C),b=0;b<3;b++)C.constrained_edge[b]||h.push(C.getNeighbor(b))},we=g,we}var Ye;function xt(){return Ye||(Ye=1,(function(i){var n=globalThis.poly2tri;i.noConflict=function(){return globalThis.poly2tri=n,i},i.VERSION=ft.version,i.PointError=Te(),i.Point=Ze(),i.Triangle=Ae(),i.SweepContext=mt();var r=et();i.triangulate=r.triangulate,i.sweep={Triangulate:r.triangulate}})(xe)),xe}var Ne=xt();function Ie(i,n={}){const r=vt(i);if(r.length<3)throw new Error("boundary must have at least 3 points");const e=yt(r),s=tt(e),l=s.width*s.height/500,u=n.maxArea??l,d=n.maxPoints??1e4,v=e.map(([y,_])=>new Ne.Point(y,_)),P=new Ne.SweepContext(v),g=jt(e,u,d);for(const[y,_]of g)P.addPoint(new Ne.Point(y,_));P.triangulate();const x=P.getTriangles(),h=new Map,C=[],b=y=>{const _=h.get(y);if(_!==void 0)return _;const Y=C.length;return C.push([y.x,y.y]),h.set(y,Y),Y},R=[];for(const y of x){const _=y.getPoints(),Y=b(_[0]),V=b(_[1]),T=b(_[2]);R.push([Y,V,T])}const E=e.map(y=>Ct(C,y));return{vertices:C,faces:R,boundaryIndices:E}}function vt(i){if(i.length===0)return[];const n=i[0],r=i[i.length-1];return n[0]===r[0]&&n[1]===r[1]?i.slice(0,-1):i.slice()}function yt(i){return bt(i)<0?i.slice().reverse():i.slice()}function bt(i){let n=0;const r=i.length;for(let e=0;e<r;e++){const s=(e+1)%r;n+=i[e][0]*i[s][1]-i[s][0]*i[e][1]}return n}function tt(i){let n=1/0,r=1/0,e=-1/0,s=-1/0;for(const[d,v]of i)d<n&&(n=d),v<r&&(r=v),d>e&&(e=d),v>s&&(s=v);const l=Math.max(0,e-n),u=Math.max(0,s-r);return{minX:n,minY:r,maxX:e,maxY:s,width:l,height:u}}function _t(i,n){const r=i[0],e=i[1];let s=!1;for(let l=0,u=n.length-1;l<n.length;u=l++){const d=n[l][0],v=n[l][1],P=n[u][0],g=n[u][1];v>e!=g>e&&r<(P-d)*(e-v)/(g-v+0)+d&&(s=!s)}return s}function jt(i,n,r){if(!Number.isFinite(n)||n<=0)return[];const e=tt(i);if(e.width===0||e.height===0)return[];const s=Math.max(2,Math.sqrt(4*n/Math.sqrt(3))),l=[];for(let u=e.minY+s/2;u<e.maxY;u+=s)for(let d=e.minX+s/2;d<e.maxX;d+=s){if(l.length>=r)return l;const v=[d,u];_t(v,i)&&l.push(v)}return l}function Ct(i,n){let r=0,e=1/0;const s=n[0],l=n[1];for(let u=0;u<i.length;u++){const d=i[u][0]-s,v=i[u][1]-l,P=d*d+v*v;P<e&&(e=P,r=u)}return r}const wt={iterations:5,cgMaxIterations:400,cgTolerance:1e-6,timeoutMs:6e4};let le=null,Nt=1;const Me=new Map;function Pt(){if(le)return le;const i=new Worker(new URL("/my-site/python-apps/assets/arapMeshDeformWorker-BLC6KUpG.js",import.meta.url),{type:"module"});return i.onmessage=n=>{const r=n.data,e=Me.get(r.id);e&&(Me.delete(r.id),r.type==="error"?e.reject(new Error(r.message)):e.resolve(r))},i.onerror=n=>{console.error("arapMeshDeformWorker error",n)},le=i,le}function St(){le&&le.terminate(),le=null}async function nt(i,n,r,e={}){const s={...wt,...e};if(n.length===0)throw new Error("faces is empty");if(r.length<2)throw new Error("at least 2 constraints are required");const l=Nt++,u=Pt(),d=new Float64Array(i.length*2);for(let y=0;y<i.length;y++)d[y*2+0]=i[y][0],d[y*2+1]=i[y][1];const v=new Uint32Array(n.length*3);for(let y=0;y<n.length;y++)v[y*3+0]=n[y][0],v[y*3+1]=n[y][1],v[y*3+2]=n[y][2];const P=new Uint32Array(r.length),g=new Float64Array(r.length*2);for(let y=0;y<r.length;y++)P[y]=r[y].index,g[y*2+0]=r[y].position[0],g[y*2+1]=r[y].position[1];const x={id:l,type:"solve",vertices:d,faces:v,constraints:P,constraintPositions:g,options:{iterations:s.iterations,cgMaxIterations:s.cgMaxIterations,cgTolerance:s.cgTolerance}},h=new Promise((y,_)=>{Me.set(l,{resolve:y,reject:_}),u.postMessage(x,[d.buffer,v.buffer,P.buffer,g.buffer])}),C=new Promise((y,_)=>{const Y=window.setTimeout(()=>{St(),_(new Error(`arapMeshDeform timed out after ${s.timeoutMs}ms`))},s.timeoutMs);h.finally(()=>window.clearTimeout(Y))}),b=await Promise.race([h,C]);if(b.type!=="result")throw new Error("Unexpected worker response");const R=[],E=b.deformedVertices;for(let y=0;y<E.length/2;y++)R.push([E[y*2+0],E[y*2+1]]);return{deformedVertices:R,iterations:b.iterations}}async function rt(i,n,r){const e=await me(i,{simplifyRatio:r.contourSimplifyRatio}),s=await Et(n,e,r),l=Ie(s.xBest,{maxArea:r.triangulationMaxArea,maxPoints:r.triangulationMaxPoints}),u=Tt(l.boundaryIndices,s.escherizedBoundary),d=await nt(l.vertices,l.faces,u,{iterations:r.arapIterations,cgMaxIterations:r.arapCgMaxIterations,cgTolerance:r.arapCgTolerance});return{contour:e,python:s,triangulation:l,arap:d}}async function Mt(i,n,r){const{contour:e,python:s,triangulation:l,arap:u}=await rt(i,n,r),d=await At(n,{tilingPattern:r.tilingPattern,m:r.m,n:r.n,tranU:s.transU,tranV:s.transV,bestIdx:s.bestIdx,bestError:s.bestError,errors:s.errors,xBest:s.xBest,escherizedBoundary:s.escherizedBoundary,vertices:l.vertices,faces:l.faces,deformedVertices:u.deformedVertices,boundaryIndices:l.boundaryIndices});return{contour:e,python:s,triangulation:l,arap:u,matplotlibPngBase64:d}}async function Et(i,n,r){const e=r.useResample?"True":"False",s=`
import numpy as np
from escherize_boundary import escherization

contour = np.array(${JSON.stringify(n.contour)}, dtype=float)
tran_u = np.array(${JSON.stringify(n.tranU)}, dtype=float)
tran_v = np.array(${JSON.stringify(n.tranV)}, dtype=float)

escherized_boundary, X_best, best_idx, best_error, errors = escherization(
    contour,
    ${JSON.stringify(r.tilingPattern)},
    int(${r.m}),
    int(${r.n}),
    ${e},
    tran_u,
    tran_v,
)

trans_u_out = None
trans_v_out = None
if ${JSON.stringify(r.tilingPattern)} == "P2":
    import p2
    trans_u_out, trans_v_out = p2.trans_uv(escherized_boundary, int(${r.m}), int(${r.n}))
elif ${JSON.stringify(r.tilingPattern)} == "P3":
    import p3
    trans_u_out, trans_v_out = p3.trans_uv(escherized_boundary, int(${r.m}))
else:
    trans_u_out = tran_u
    trans_v_out = tran_v
`;await i.runPythonAsync(s);const l=i.globals.get("escherized_boundary").toJs(),u=i.globals.get("X_best").toJs(),d=qe(i.globals.get("best_idx")),v=qe(i.globals.get("best_error")),P=i.globals.get("errors").toJs()??[],g=Ue(i.globals.get("trans_u_out")),x=Ue(i.globals.get("trans_v_out"));return{escherizedBoundary:l.map(h=>[h[0],h[1]]),xBest:u.map(h=>[h[0],h[1]]),bestIdx:d,bestError:v,errors:Array.from(P),transU:g,transV:x}}function Tt(i,n){if(i.length!==n.length)throw new Error(`boundary indices/positions mismatch: ${i.length} vs ${n.length}`);const r=new Map;for(let e=0;e<i.length;e++)r.set(i[e],n[e]);return Array.from(r.entries()).map(([e,s])=>({index:e,position:s}))}async function At(i,n){const r=`
import numpy as np
from visualize_matplotlib import render_escherization_matplotlib_png_base64

X_best = np.array(${JSON.stringify(n.xBest)}, dtype=float)
errors = np.array(${JSON.stringify(n.errors)}, dtype=float)
escherized_boundary = np.array(${JSON.stringify(n.escherizedBoundary)}, dtype=float)
vertices = np.array(${JSON.stringify(n.vertices)}, dtype=float)
faces = np.array(${JSON.stringify(n.faces)}, dtype=int)
deformed_vertices = np.array(${JSON.stringify(n.deformedVertices)}, dtype=float)
boundary_indices = np.array(${JSON.stringify(n.boundaryIndices)}, dtype=int)
tran_u = np.array(${JSON.stringify(n.tranU)}, dtype=float)
tran_v = np.array(${JSON.stringify(n.tranV)}, dtype=float)

matplotlib_png_b64 = render_escherization_matplotlib_png_base64(
    X_best,
    int(${n.bestIdx}),
    errors,
    float(${n.bestError}),
    escherized_boundary,
    vertices,
    faces,
    deformed_vertices,
    boundary_indices,
    ${JSON.stringify(n.tilingPattern)},
    int(${n.m}),
    int(${n.n}),
    tran_u=tran_u,
    tran_v=tran_v,
    dpi=150,
)
`;await i.runPythonAsync(r);const e=i.globals.get("matplotlib_png_b64");return typeof e?.toJs=="function"?String(e.toJs()):String(e)}function qe(i){return i==null?NaN:typeof i=="number"?i:typeof i?.toJs=="function"?Number(i.toJs()):Number(i)}function Ue(i){if(i==null)return[0,0];if(typeof i?.toJs=="function"){const n=i.toJs();return[Number(n[0]??0),Number(n[1]??0)]}return Array.isArray(i)?[Number(i[0]??0),Number(i[1]??0)]:[0,0]}function It(){const i=f.useMemo(()=>["escherization/escherize_boundary.py","escherization/p1.py","escherization/p2.py","escherization/p3.py","escherization/tiling_condition.py","escherization/visualize_matplotlib.py"],[]),{pyodide:n,isReady:r,error:e}=Ke(i,{packages:["matplotlib"]}),[s,l]=f.useState(null),[u,d]=f.useState("P2"),[v,P]=f.useState(21),[g,x]=f.useState(21),[h,C]=f.useState(!0),[b,R]=f.useState(.008),[E]=f.useState(""),[y,_]=f.useState(4e3),[Y,V]=f.useState(5),[T,S]=f.useState(400),[N,z]=f.useState(1e-6),[F,k]=f.useState(null),[U,q]=f.useState("待機中"),[H,Z]=f.useState(null),[O,ee]=f.useState(!1),J=f.useMemo(()=>{const A=Number(E);return Number.isFinite(A)&&A>0?A:void 0},[E]),te=f.useCallback(async()=>{if(s&&!(!n||!r)){ee(!0),Z(null),k(null);try{q("画像読み込み...");const A=await ge(s),ne={tilingPattern:u,m:v,n:g,useResample:h,contourSimplifyRatio:b,triangulationMaxArea:J,triangulationMaxPoints:y,arapIterations:Y,arapCgMaxIterations:T,arapCgTolerance:N};q("輪郭抽出→Pythonエッシャー化→メッシュ→ASAP→Matplotlib...");const G=await Mt(A,n,ne);k(G.matplotlibPngBase64),q(`完了: contour=${G.contour.contour.length}, xBest=${G.python.xBest.length}, verts=${G.triangulation.vertices.length}, tris=${G.triangulation.faces.length}`)}catch(A){console.error("pipeline failed",A),Z(A instanceof Error?A.message:String(A)),q("失敗")}finally{ee(!1)}}},[Y,T,N,b,s,r,v,g,J,n,u,y,h]);return t.jsxs("section",{children:[t.jsx("h2",{children:"Matplotlib Debug Pipeline"}),t.jsx("p",{children:"Web実装（輪郭/メッシュ/ASAP）+ Python（escherize_boundary）で一連処理を実行し、Matplotlib結果を確認します。"}),t.jsxs("div",{className:"escher-controls",children:[t.jsxs("label",{className:"control",children:[t.jsx("span",{children:"画像ファイル"}),t.jsx("input",{type:"file",accept:"image/*",onChange:A=>l(A.target.files?.[0]??null)})]}),t.jsxs("div",{className:"controls-row",children:[t.jsxs("label",{className:"control",children:[t.jsx("span",{children:"tilingPattern"}),t.jsxs("select",{value:u,onChange:A=>d(A.target.value),children:[t.jsx("option",{value:"P2",children:"P2"}),t.jsx("option",{value:"P3",children:"P3"}),t.jsx("option",{value:"P1",children:"P1"})]})]}),t.jsxs("label",{className:"control",children:[t.jsx("span",{children:"m"}),t.jsx("input",{type:"number",step:"1",min:"3",value:v,onChange:A=>P(Number(A.target.value))})]}),t.jsxs("label",{className:"control",children:[t.jsx("span",{children:"n"}),t.jsx("input",{type:"number",step:"1",min:"3",value:g,onChange:A=>x(Number(A.target.value))})]}),t.jsxs("label",{className:"control",children:[t.jsx("span",{children:"resample"}),t.jsxs("select",{value:h?"1":"0",onChange:A=>C(A.target.value==="1"),children:[t.jsx("option",{value:"1",children:"true"}),t.jsx("option",{value:"0",children:"false"})]})]})]}),t.jsxs("div",{className:"controls-row",children:[t.jsxs("label",{className:"control",children:[t.jsx("span",{children:"contour simplifyRatio"}),t.jsx("input",{type:"number",step:"0.001",min:"0",value:b,onChange:A=>R(Number(A.target.value))})]}),t.jsxs("label",{className:"control",children:[t.jsx("span",{children:"tri maxPoints"}),t.jsx("input",{type:"number",step:"100",min:"0",value:y,onChange:A=>_(Number(A.target.value))})]})]}),t.jsxs("div",{className:"controls-row",children:[t.jsxs("label",{className:"control",children:[t.jsx("span",{children:"ASAP iters"}),t.jsx("input",{type:"number",step:"1",min:"1",value:Y,onChange:A=>V(Number(A.target.value))})]}),t.jsxs("label",{className:"control",children:[t.jsx("span",{children:"CG iters"}),t.jsx("input",{type:"number",step:"50",min:"1",value:T,onChange:A=>S(Number(A.target.value))})]}),t.jsxs("label",{className:"control",children:[t.jsx("span",{children:"CG tol"}),t.jsx("input",{type:"number",step:"1e-6",min:"0",value:N,onChange:A=>z(Number(A.target.value))})]})]}),e&&t.jsxs("div",{className:"error",children:["Pyodideエラー: ",e]}),!e&&!r&&t.jsx("div",{className:"error",children:"Pyodideロード中..."}),H&&t.jsxs("div",{className:"error",children:["エラー: ",H]}),t.jsxs("div",{className:"controls-row",children:[t.jsx("button",{className:"run-button",onClick:te,disabled:!s||!r||!n||O,children:O?"処理中...":"実行"}),t.jsxs("div",{className:"control",children:[t.jsx("span",{children:"status"}),t.jsx("input",{value:U,readOnly:!0})]})]})]}),F&&t.jsx("div",{className:"canvas-wrap",style:{marginTop:16},children:t.jsx("img",{alt:"matplotlib result",src:`data:image/png;base64,${F}`,style:{maxWidth:"100%",height:"auto",display:"block"}})})]})}function kt(i,n){const r=i[0]-n[0],e=i[1]-n[1];return r*r+e*e}function Le(i,n){const r=i.getBoundingClientRect(),e=i.width/r.width,s=i.height/r.height,l=(n.clientX-r.left)*e,u=(n.clientY-r.top)*s;return[l,u]}function Ve(i,n,r,e,s){i.beginPath(),i.arc(n[0],n[1],r,0,Math.PI*2),i.fillStyle=e,i.fill(),i.lineWidth=2,i.strokeStyle=s,i.stroke()}function Wt(){const[i,n]=f.useState(null),[r,e]=f.useState(.008),[s,l]=f.useState(""),[u,d]=f.useState(4e3),[v,P]=f.useState(5),[g,x]=f.useState(400),[h,C]=f.useState(1e-6),[b,R]=f.useState("draggable"),[E,y]=f.useState(null),[_,Y]=f.useState(null),[V,T]=f.useState([]),[S,N]=f.useState(null),[z,F]=f.useState(null),[k,U]=f.useState(null),[q,H]=f.useState(null),[Z,O]=f.useState(null),[ee,J]=f.useState(!1),te=f.useRef(null),A=f.useRef(!1),ne=f.useRef(!1),G=f.useRef(null),se=f.useMemo(()=>{const w=Number(s);return Number.isFinite(w)&&w>0?w:void 0},[s]),K=f.useMemo(()=>!_||S===null?null:_.vertices[S],[S,_]),c=f.useCallback((w,X,m,W,$)=>{const B=te.current;if(!B)return;const M=B.getContext("2d");if(!M)return;B.width=w.imageData.width,B.height=w.imageData.height,M.putImageData(w.imageData,0,0),M.save(),M.globalAlpha=.55,M.strokeStyle="rgba(0, 102, 255, 1)",M.lineWidth=Math.max(1,Math.floor(Math.min(B.width,B.height)/700));for(const[re,ce,ue]of X.faces){const he=m[re],de=m[ce],ke=m[ue];M.beginPath(),M.moveTo(he[0],he[1]),M.lineTo(de[0],de[1]),M.lineTo(ke[0],ke[1]),M.closePath(),M.stroke()}M.restore(),M.save(),M.globalAlpha=.85,M.strokeStyle="rgba(0,0,0,0.65)",M.lineWidth=Math.max(2,Math.floor(Math.min(B.width,B.height)/450));const Q=w.contour;if(Q.length>=2){M.beginPath(),M.moveTo(Q[0][0],Q[0][1]);for(let re=1;re<Q.length;re++)M.lineTo(Q[re][0],Q[re][1]);M.closePath(),M.stroke()}M.restore();const ie=Math.max(4,Math.floor(Math.min(B.width,B.height)/180));W&&Ve(M,W,ie,"rgba(255, 220, 0, 0.9)","rgba(0,0,0,0.7)"),$&&Ve(M,$,ie,"rgba(255, 0, 160, 0.9)","rgba(0,0,0,0.7)")},[]),a=f.useCallback(w=>{if(!_||V.length===0)return null;let X=null,m=1/0;for(const B of V){const M=kt(_.vertices[B],w);M<m&&(m=M,X=B)}const W=te.current;if(!W)return X;const $=Math.max(10,Math.min(W.width,W.height)/40);return m<=$*$?X:null},[V,_]),o=f.useCallback(async w=>{if(!(!_||!q||S===null||z===null)&&S!==z&&K){ne.current=!0;try{const X=await nt(_.vertices,_.faces,[{index:S,position:K},{index:z,position:w}],{iterations:v,cgMaxIterations:g,cgTolerance:h});H(X.deformedVertices),E&&c(E,_,X.deformedVertices,K,w)}finally{ne.current=!1}}},[v,g,h,q,c,z,S,K,_,E]),p=f.useCallback(w=>{if(G.current=w,ne.current)return;const X=async()=>{const m=G.current;m&&(G.current=null,await o(m),G.current&&await X())};X()},[o]),j=f.useCallback(async()=>{if(i){J(!0),O(null),y(null),Y(null),H(null),N(null),F(null),U(null),T([]);try{const w=await ge(i),X=await me(w,{simplifyRatio:r}),m=Ie(X.contour,{maxArea:se,maxPoints:u}),W=Array.from(new Set(m.boundaryIndices));if(W.length<2)throw new Error("boundary vertices not found");const $=W[0],B=W[Math.floor(W.length/2)],M=m.vertices[B];y(X),Y(m),T(W),N($),F(B),U(M),H(m.vertices),c(X,m,m.vertices,m.vertices[$],M)}catch(w){console.error("ARAP interactive test failed:",w),O(w instanceof Error?w.message:String(w))}finally{J(!1)}}},[c,i,se,r,u]),D=f.useCallback(w=>{const X=te.current;if(!X||!_||!q)return;const m=Le(X,w),W=a(m);if(W===null)return;if(b==="fixed"){if(z!==null&&W===z)return;N(W),E&&k&&c(E,_,q,_.vertices[W],k);return}if(S!==null&&W===S)return;F(W);const $=q[W];U($),E&&c(E,_,q,K,$),A.current=!0},[q,z,k,c,S,K,_,b,a,E]),I=f.useCallback(w=>{const X=te.current;if(!X||!_||!E||!A.current||S===null||z===null||S===z)return;const m=Le(X,w);U(m),p(m)},[z,S,_,E,p]),L=f.useCallback(()=>{A.current=!1},[]);return t.jsxs("section",{children:[t.jsx("h2",{children:"ARAP (Interactive)"}),t.jsx("p",{children:"境界上の固定点1つ + ドラッグ点1つでメッシュをARAP変形（`arap-mesh-deform`実装を2D/Worker向けに移植）"}),t.jsxs("div",{className:"escher-controls",children:[t.jsxs("label",{className:"control",children:[t.jsx("span",{children:"画像ファイル"}),t.jsx("input",{type:"file",accept:"image/*",onChange:w=>n(w.target.files?.[0]??null)})]}),t.jsxs("div",{className:"controls-row",children:[t.jsxs("label",{className:"control",children:[t.jsx("span",{children:"simplifyRatio"}),t.jsx("input",{type:"number",step:"0.001",min:"0",value:r,onChange:w=>e(Number(w.target.value))})]}),t.jsxs("label",{className:"control",children:[t.jsx("span",{children:"tri maxArea (empty=auto)"}),t.jsx("input",{type:"number",step:"1",min:"0",value:s,onChange:w=>l(w.target.value)})]}),t.jsxs("label",{className:"control",children:[t.jsx("span",{children:"tri maxPoints"}),t.jsx("input",{type:"number",step:"100",min:"0",value:u,onChange:w=>d(Number(w.target.value))})]}),t.jsxs("label",{className:"control",children:[t.jsx("span",{children:"ARAP iters"}),t.jsx("input",{type:"number",step:"1",min:"1",value:v,onChange:w=>P(Number(w.target.value))})]}),t.jsxs("label",{className:"control",children:[t.jsx("span",{children:"CG iters"}),t.jsx("input",{type:"number",step:"50",min:"1",value:g,onChange:w=>x(Number(w.target.value))})]}),t.jsxs("label",{className:"control",children:[t.jsx("span",{children:"CG tol"}),t.jsx("input",{type:"number",step:"1e-6",min:"0",value:h,onChange:w=>C(Number(w.target.value))})]}),t.jsx("button",{className:"run-button",onClick:j,disabled:!i||ee,children:ee?"処理中...":"メッシュ生成"})]}),t.jsxs("div",{className:"controls-row",children:[t.jsxs("label",{className:"control",children:[t.jsx("span",{children:"ピックモード"}),t.jsxs("select",{value:b,onChange:w=>R(w.target.value),children:[t.jsx("option",{value:"draggable",children:"Draggable（クリックで選択→そのままドラッグ）"}),t.jsx("option",{value:"fixed",children:"Fixed（クリックで固定点を設定）"})]})]}),t.jsxs("div",{className:"control",children:[t.jsx("span",{children:"fixed index"}),t.jsx("input",{value:S??"",readOnly:!0})]}),t.jsxs("div",{className:"control",children:[t.jsx("span",{children:"draggable index"}),t.jsx("input",{value:z??"",readOnly:!0})]})]}),Z&&t.jsxs("div",{className:"error",children:["エラー: ",Z]})]}),t.jsxs("div",{className:"escher-output",children:[t.jsx("div",{className:"canvas-wrap",children:t.jsx("canvas",{ref:te,onMouseDown:D,onMouseMove:I,onMouseUp:L,onMouseLeave:L})}),t.jsxs("div",{className:"stats",children:[t.jsx("h3",{children:"状態"}),!E||!_?t.jsx("p",{children:"「メッシュ生成」を押してください。"}):t.jsxs("dl",{children:[t.jsxs("div",{className:"kv",children:[t.jsx("dt",{children:"contour points"}),t.jsx("dd",{children:E.contour.length})]}),t.jsxs("div",{className:"kv",children:[t.jsx("dt",{children:"vertices"}),t.jsx("dd",{children:_.vertices.length})]}),t.jsxs("div",{className:"kv",children:[t.jsx("dt",{children:"triangles"}),t.jsx("dd",{children:_.faces.length})]}),t.jsxs("div",{className:"kv",children:[t.jsx("dt",{children:"boundary unique"}),t.jsx("dd",{children:V.length})]})]})]})]})]})}function Rt(i,n,r){return Math.abs((n[0]-i[0])*(r[1]-i[1])-(n[1]-i[1])*(r[0]-i[0]))}function zt(){const[i,n]=f.useState(null),[r,e]=f.useState(.008),[s,l]=f.useState(""),[u,d]=f.useState(1e4),[v,P]=f.useState(9e4),[g,x]=f.useState(null),[h,C]=f.useState(null),[b,R]=f.useState(null),[E,y]=f.useState(!1),_=f.useRef(null),Y=f.useMemo(()=>{const N=Number(s);return Number.isFinite(N)&&N>0?N:void 0},[s]),V=f.useCallback((N,z)=>{const F=_.current;if(!F)return;const k=F.getContext("2d");if(!k)return;F.width=N.imageData.width,F.height=N.imageData.height,k.putImageData(N.imageData,0,0),k.save(),k.lineWidth=Math.max(1,Math.floor(Math.min(F.width,F.height)/700)),k.globalAlpha=.45,k.strokeStyle="rgba(0, 102, 255, 1)";for(const[q,H,Z]of z.faces){const O=z.vertices[q],ee=z.vertices[H],J=z.vertices[Z];k.beginPath(),k.moveTo(O[0],O[1]),k.lineTo(ee[0],ee[1]),k.lineTo(J[0],J[1]),k.closePath(),k.stroke()}k.globalAlpha=.9,k.strokeStyle="rgba(255, 0, 0, 1)",k.lineWidth=Math.max(2,Math.floor(Math.min(F.width,F.height)/450));const U=N.contour;if(U.length>=2){k.beginPath(),k.moveTo(U[0][0],U[0][1]);for(let q=1;q<U.length;q++)k.lineTo(U[q][0],U[q][1]);k.closePath(),k.stroke()}k.restore()},[]),T=f.useCallback(async()=>{if(i){y(!0),R(null),x(null),C(null);try{const N=await ge(i),z=await me(N,{simplifyRatio:r,timeoutMs:v}),F=Ie(z.contour,{maxArea:Y,maxPoints:u});x(z),C(F),V(z,F)}catch(N){console.error("Triangulation test failed:",N),R(N instanceof Error?N.message:String(N))}finally{y(!1)}}},[V,i,u,Y,r,v]),S=f.useMemo(()=>{if(!h)return null;let N=1/0,z=-1/0,F=0;for(const[U,q,H]of h.faces){const O=Rt(h.vertices[U],h.vertices[q],h.vertices[H])/2;O<N&&(N=O),O>z&&(z=O),F+=O}const k=h.faces.length?F/h.faces.length:0;return{vertices:h.vertices.length,faces:h.faces.length,boundary:h.boundaryIndices.length,interior:h.vertices.length-h.boundaryIndices.length,minArea:Number.isFinite(N)?N:0,maxArea:Number.isFinite(z)?z:0,meanArea:k}},[h]);return t.jsxs("section",{children:[t.jsx("h2",{children:"triangulate_boundary (Test)"}),t.jsx("p",{children:"輪郭点から三角形分割（poly2tri + Steiner点追加で面積制御を近似）"}),t.jsxs("div",{className:"escher-controls",children:[t.jsxs("label",{className:"control",children:[t.jsx("span",{children:"画像ファイル"}),t.jsx("input",{type:"file",accept:"image/*",onChange:N=>n(N.target.files?.[0]??null)})]}),t.jsxs("div",{className:"controls-row",children:[t.jsxs("label",{className:"control",children:[t.jsx("span",{children:"simplifyRatio"}),t.jsx("input",{type:"number",step:"0.001",min:"0",value:r,onChange:N=>e(Number(N.target.value))})]}),t.jsxs("label",{className:"control",children:[t.jsx("span",{children:"maxArea (empty=auto)"}),t.jsx("input",{type:"number",step:"1",min:"0",value:s,onChange:N=>l(N.target.value)})]}),t.jsxs("label",{className:"control",children:[t.jsx("span",{children:"maxPoints"}),t.jsx("input",{type:"number",step:"100",min:"0",value:u,onChange:N=>d(Number(N.target.value))})]}),t.jsxs("label",{className:"control",children:[t.jsx("span",{children:"timeout (ms)"}),t.jsx("input",{type:"number",step:"1000",min:"1000",value:v,onChange:N=>P(Number(N.target.value))})]}),t.jsx("button",{className:"run-button",onClick:T,disabled:!i||E,children:E?"処理中...":"実行"})]}),b&&t.jsxs("div",{className:"error",children:["エラー: ",b]})]}),t.jsxs("div",{className:"escher-output",children:[t.jsx("div",{className:"canvas-wrap",children:t.jsx("canvas",{ref:_})}),t.jsxs("div",{className:"stats",children:[t.jsx("h3",{children:"結果"}),!g||!h||!S?t.jsx("p",{children:"画像を選んで「実行」を押してください。"}):t.jsxs("dl",{children:[t.jsxs("div",{className:"kv",children:[t.jsx("dt",{children:"contour points"}),t.jsx("dd",{children:g.contour.length})]}),t.jsxs("div",{className:"kv",children:[t.jsx("dt",{children:"vertices"}),t.jsx("dd",{children:S.vertices})]}),t.jsxs("div",{className:"kv",children:[t.jsx("dt",{children:"triangles"}),t.jsx("dd",{children:S.faces})]}),t.jsxs("div",{className:"kv",children:[t.jsx("dt",{children:"boundary"}),t.jsxs("dd",{children:[S.boundary," / interior ",S.interior]})]}),t.jsxs("div",{className:"kv",children:[t.jsx("dt",{children:"area (min/mean/max)"}),t.jsxs("dd",{children:[S.minArea.toFixed(2)," / ",S.meanArea.toFixed(2)," / ",S.maxArea.toFixed(2)]})]})]})]})]})]})}function Dt(i){const{tilingPattern:n,m:r,n:e,nx:s,ny:l,deformedVertices:u,escherizedBoundary:d,transU:v,transV:P}=i,g=n==="P2"?Ot(u,d,r,e):n==="P3"?Xt(u,d,r):[u],x=[],h=n==="P2"?Math.max(1,Math.floor(s/2)):Math.max(1,Math.floor(s)),C=n==="P2"?Math.max(1,Math.floor(l/2)):Math.max(1,Math.floor(l));for(let b=0;b<h;b++)for(let R=0;R<C;R++){const E=[v[0]*b+P[0]*R,v[1]*b+P[1]*R];for(const y of g)x.push(Yt(y,E))}return x}function Bt({ctx:i,image:n,sourceVertices:r,faces:e,tiles:s,width:l,height:u,view:d}){i.setTransform(1,0,0,1,0,0),i.clearRect(0,0,l,u),$t(i,l,u);const v=Ft(s),P=Math.max(1e-6,v.maxX-v.minX),g=Math.max(1e-6,v.maxY-v.minY),x=24,h=Math.max(1,l-x*2),C=Math.max(1,u-x*2),b=Math.max(h/P,C/g),R=d?.zoom??1,E=l/2,y=u/2,_=(v.minX+v.maxX)/2,Y=(v.minY+v.maxY)/2,V=E-_*b,T=y-Y*b,S=b*R,N=V*R+(d?.panX??0),z=T*R+(d?.panY??0),F=k=>[k[0]*S+N,k[1]*S+z];i.imageSmoothingEnabled=!0;for(const k of s)for(const U of e){const q=r[U[0]],H=r[U[1]],Z=r[U[2]],O=F(k[U[0]]),ee=F(k[U[1]]),J=F(k[U[2]]);Vt(i,n,q,H,Z,O,ee,J)}}function $t(i,n,r){const e=i.createLinearGradient(0,0,n,r);e.addColorStop(0,"#f8fafc"),e.addColorStop(1,"#e2e8f0"),i.fillStyle=e,i.fillRect(0,0,n,r),i.strokeStyle="rgba(15, 23, 42, 0.08)",i.lineWidth=1;const s=48;for(let l=0;l<=n;l+=s)i.beginPath(),i.moveTo(l,0),i.lineTo(l,r),i.stroke();for(let l=0;l<=r;l+=s)i.beginPath(),i.moveTo(0,l),i.lineTo(n,l),i.stroke()}function Ft(i){let n=1/0,r=1/0,e=-1/0,s=-1/0;for(const l of i)for(const[u,d]of l)u<n&&(n=u),d<r&&(r=d),u>e&&(e=u),d>s&&(s=d);return Number.isFinite(n)||(n=0,r=0,e=1,s=1),{minX:n,minY:r,maxX:e,maxY:s}}function Ot(i,n,r,e){const{center0:s,center1:l,center2:u}=Ut(r,e),d=n[l],v=n[u],P=n[s],g=Math.PI,x=fe(i,d,g),h=fe(i,v,g),C=qt(P,d,g),b=fe(x,C,g);return[i,x,h,b]}function Xt(i,n,r){const e=Lt(r),s=fe(i,n[e[0]],-2*Math.PI/3),l=fe(i,n[e[1]],2*Math.PI/3);return[i,s,l]}function Yt(i,n){return i.map(([r,e])=>[r+n[0],e+n[1]])}function fe(i,n,r){const e=Math.cos(r),s=Math.sin(r),l=n[0],u=n[1];return i.map(([d,v])=>{const P=d-l,g=v-u;return[e*P-s*g+l,s*P+e*g+u]})}function qt(i,n,r){const e=Math.cos(r),s=Math.sin(r),l=i[0]-n[0],u=i[1]-n[1];return[e*l-s*u+n[0],s*l+e*u+n[1]]}function Ut(i,n){const r=Array.from({length:i},(u,d)=>d),e=Array.from({length:n},(u,d)=>i-1+d),s=Array.from({length:i},(u,d)=>i+n-2+d),l=Array.from({length:n},(u,d)=>2*i+n-3+d);return l[l.length-1]=0,{center0:r[Math.floor(r.length/2)],center1:e[Math.floor(e.length/2)],center2:s[Math.floor(s.length/2)],center3:l[Math.floor(l.length/2)]}}function Lt(i){const n=Array.from({length:i},(u,d)=>d);let r=i-1;r=r+i-1;const e=Array.from({length:i},(u,d)=>r+d);r=r+i-1,r=r+i-1;const s=Array.from({length:i},(u,d)=>r+d);r=r+i-1;const l=Array.from({length:i},(u,d)=>r+d);return l[l.length-1]=0,[n[n.length-1],e[e.length-1],s[s.length-1]]}function Vt(i,n,r,e,s,l,u,d){const v=r[0]*(e[1]-s[1])+e[0]*(s[1]-r[1])+s[0]*(r[1]-e[1]);if(Math.abs(v)<1e-8)return;const P=(l[0]*(e[1]-s[1])+u[0]*(s[1]-r[1])+d[0]*(r[1]-e[1]))/v,g=(l[1]*(e[1]-s[1])+u[1]*(s[1]-r[1])+d[1]*(r[1]-e[1]))/v,x=(l[0]*(s[0]-e[0])+u[0]*(r[0]-s[0])+d[0]*(e[0]-r[0]))/v,h=(l[1]*(s[0]-e[0])+u[1]*(r[0]-s[0])+d[1]*(e[0]-r[0]))/v,C=(l[0]*(e[0]*s[1]-s[0]*e[1])+u[0]*(s[0]*r[1]-r[0]*s[1])+d[0]*(r[0]*e[1]-e[0]*r[1]))/v,b=(l[1]*(e[0]*s[1]-s[0]*e[1])+u[1]*(s[0]*r[1]-r[0]*s[1])+d[1]*(r[0]*e[1]-e[0]*r[1]))/v;i.save(),i.beginPath(),i.moveTo(l[0],l[1]),i.lineTo(u[0],u[1]),i.lineTo(d[0],d[1]),i.closePath(),i.clip(),i.setTransform(P,g,x,h,C,b),i.drawImage(n,0,0),i.restore()}const Jt="/my-site/python-apps/",Je=[{value:"yumekawa_animal_usagi.png",label:"ゆめかわ うさぎ"},{value:"asobu_cat_shadow.png",label:"遊ぶ ねこ"},{value:"eto_uma_banzai.png",label:"干支 うま"},{value:"eto_ushi_banzai.png",label:"干支 うし"},{value:"point_katen_woman.png",label:"ポイント 女性"},{value:"seiji_souridaijin_bg3.png",label:"政治 総理大臣"}];function He(){const i=f.useMemo(()=>["escherization/escherize_boundary.py","escherization/p1.py","escherization/p2.py","escherization/p3.py","escherization/tiling_condition.py"],[]),{pyodide:n,isReady:r,error:e}=Ke(i),s=f.useRef(null),l=f.useRef(null),[u,d]=f.useState("sample"),[v,P]=f.useState(null),[g,x]=f.useState(Je[0].value),[h,C]=f.useState("P3"),[b,R]=f.useState(21),[E,y]=f.useState(21),[_,Y]=f.useState(5),[V,T]=f.useState(5),[S,N]=f.useState(.005),[z]=f.useState(""),[F,k]=f.useState("待機中"),[U,q]=f.useState(null),[H,Z]=f.useState(!1),[O,ee]=f.useState(null),[J,te]=f.useState(null),[A,ne]=f.useState({width:900,height:600}),[G,se]=f.useState({zoom:1,panX:0,panY:0}),K=f.useRef({isDragging:!1,lastX:0,lastY:0}),c=f.useRef(null),a=f.useRef(G);f.useEffect(()=>{h==="P2"&&(b%2===0&&R(m=>m+1),E%2===0&&y(m=>m+1))},[b,E,h]),f.useEffect(()=>{const m=l.current;if(!m)return;const W=()=>{const B=Math.max(320,m.clientWidth),M=Math.max(420,m.clientHeight||640);ne({width:B,height:M})};W();const $=new ResizeObserver(W);return $.observe(m),()=>$.disconnect()},[]),f.useEffect(()=>()=>{J?.close()},[J]);const o=f.useMemo(()=>{const m=Number(z);return Number.isFinite(m)&&m>0?m:void 0},[z]),p=f.useMemo(()=>h!=="P2"?{m:b,n:E}:{m:b%2===0?b+1:b,n:E%2===0?E+1:E},[b,E,h]),j=f.useCallback(async(m,W,$)=>{if(!(!n||!r)){Z(!0),q(null),ee(null);try{te(m);const B={tilingPattern:h,m:p.m,n:p.n,useResample:!0,contourSimplifyRatio:S,triangulationMaxArea:o,triangulationMaxPoints:4e3,arapIterations:8,arapCgMaxIterations:300,arapCgTolerance:1e-6};k("輪郭抽出→Pythonエッシャー化→メッシュ→ASAP...");const M=await rt(W,n,B);ee(M),c.current=`${h}:${p.m}:${p.n}:${S}:${$}`,k(`完了: verts=${M.triangulation.vertices.length}, tris=${M.triangulation.faces.length}`)}catch(B){console.error("main pipeline failed",B),q(B instanceof Error?B.message:String(B)),k("失敗")}finally{Z(!1)}}},[S,r,p.m,p.n,o,n,h]),D=f.useCallback(async()=>{if(!n||!r)return;if(k("画像読み込み..."),u==="file"){if(!v)return;const M=await createImageBitmap(v),Q=Pe(M);await j(M,Q,"file");return}const m=await fetch(`${Jt}escherization/sample_images/${g}`);if(!m.ok)throw new Error(`サンプル画像の取得に失敗しました: ${m.status} ${m.statusText}`);const W=await m.blob(),$=await createImageBitmap(W),B=Pe($);await j($,B,`sample:${g}`)},[u,v,r,n,j,g]);f.useEffect(()=>{if(!n||!r||H||u==="file"&&!v)return;const m=u==="file"?"file":`sample:${g}`;`${h}:${p.m}:${p.n}:${S}:${m}`!==c.current&&D()},[u,S,v,r,H,p.m,p.n,n,D,g,h]),f.useEffect(()=>{a.current=G},[G]),f.useEffect(()=>{const m=s.current;if(!m)return;const W=$=>{$.preventDefault();const B=m.getBoundingClientRect(),M=$.clientX-B.left,Q=$.clientY-B.top,ie=a.current,re=Math.exp(-$.deltaY*.0015),ce=Math.min(6,Math.max(.2,ie.zoom*re)),ue=ce/ie.zoom,he=M-(M-ie.panX)*ue,de=Q-(Q-ie.panY)*ue;se({zoom:ce,panX:he,panY:de})};return m.addEventListener("wheel",W,{passive:!1}),()=>m.removeEventListener("wheel",W)},[]),f.useEffect(()=>{if(!O||!J)return;const m=s.current;if(!m)return;m.width=A.width,m.height=A.height;const W=m.getContext("2d");if(!W)return;const $=Dt({tilingPattern:h,m:p.m,n:p.n,nx:_,ny:V,deformedVertices:O.arap.deformedVertices,escherizedBoundary:O.python.escherizedBoundary,transU:O.python.transU,transV:O.python.transV});Bt({ctx:W,image:J,sourceVertices:O.triangulation.vertices,faces:O.triangulation.faces,tiles:$,width:A.width,height:A.height,view:G})},[A.height,A.width,_,V,p.m,p.n,O,J,h,G]);const I=t.jsx("p",{className:"escher-help",children:"P1は平行移動のみ、P2は180度回転＋平行移動（辺U/辺Vの頂点数は奇数に自動補正）、P3は120度回転＋平行移動（1辺の頂点数のみ使用）です。"}),L=h==="P2"?4:h==="P3"?3:1,w=h==="P2"?Math.max(1,Math.floor(_/2)):Math.max(1,Math.floor(_)),X=h==="P2"?Math.max(1,Math.floor(V/2)):Math.max(1,Math.floor(V));return t.jsxs("section",{className:"escher-main-page",children:[t.jsx("header",{className:"escher-main-hero",children:t.jsxs("div",{children:[t.jsx("h2",{children:"Escherization Tiling（エッシャー化）"}),t.jsx("p",{children:"画像→輪郭→エッシャー化→メッシュ変形をWebで実行し、タイリング表示します。"})]})}),t.jsxs("div",{className:"escher-main-grid",children:[t.jsxs("div",{className:"escher-panel-stack",children:[t.jsxs("div",{className:"escher-panel",children:[t.jsx("h3",{children:"サンプル画像"}),t.jsxs("label",{className:"control",children:[t.jsx("span",{children:"サンプル選択"}),t.jsx("select",{value:g,onChange:m=>{x(m.target.value),d("sample")},children:Je.map(m=>t.jsx("option",{value:m.value,children:m.label},m.value))})]})]}),t.jsxs("div",{className:"escher-panel",children:[t.jsx("h3",{children:"入力画像"}),t.jsxs("label",{className:"control",children:[t.jsx("span",{children:"画像ファイル"}),t.jsx("input",{type:"file",accept:"image/*",onChange:m=>{P(m.target.files?.[0]??null),d("file"),m.target.files?.[0]&&D()}})]})]}),t.jsxs("div",{className:"escher-panel",children:[t.jsx("h3",{children:"タイリング設定"}),t.jsxs("label",{className:"control",children:[t.jsx("span",{children:"タイリングパターン"}),t.jsxs("select",{value:h,onChange:m=>C(m.target.value),children:[t.jsx("option",{value:"P2",children:"P2"}),t.jsx("option",{value:"P3",children:"P3"}),t.jsx("option",{value:"P1",children:"P1"})]})]}),I,t.jsx("div",{className:"controls-row",children:h==="P3"?t.jsxs("label",{className:"control",children:[t.jsx("span",{children:"1辺の頂点数"}),t.jsx("input",{type:"number",step:"1",min:"3",value:b,onChange:m=>R(Number(m.target.value))})]}):t.jsxs(t.Fragment,{children:[t.jsxs("label",{className:"control",children:[t.jsx("span",{children:"辺Uの頂点数"}),t.jsx("input",{type:"number",step:"1",min:"3",value:b,onChange:m=>R(Number(m.target.value))})]}),t.jsxs("label",{className:"control",children:[t.jsx("span",{children:"辺Vの頂点数"}),t.jsx("input",{type:"number",step:"1",min:"3",value:E,onChange:m=>y(Number(m.target.value))})]})]})}),t.jsxs("div",{className:"controls-row",children:[t.jsxs("label",{className:"control",children:[t.jsx("span",{children:"タイル数 nx"}),t.jsx("input",{type:"number",step:"1",min:"1",value:_,onChange:m=>Y(Number(m.target.value))})]}),t.jsxs("label",{className:"control",children:[t.jsx("span",{children:"タイル数 ny"}),t.jsx("input",{type:"number",step:"1",min:"1",value:V,onChange:m=>T(Number(m.target.value))})]})]})]}),t.jsxs("div",{className:"escher-panel",children:[t.jsx("h3",{children:"輪郭 & メッシュ"}),t.jsx("div",{className:"controls-row",children:t.jsxs("label",{className:"control",children:[t.jsx("span",{children:"輪郭の細かさ"}),t.jsxs("select",{value:String(S),onChange:m=>N(Number(m.target.value)),children:[t.jsx("option",{value:"0.001",children:"細かい (0.001)"}),t.jsx("option",{value:"0.005",children:"中 (0.005)"}),t.jsx("option",{value:"0.01",children:"荒い (0.01)"})]})]})})]}),e&&t.jsxs("div",{className:"error",children:["Pyodideエラー: ",e]}),!e&&!r&&t.jsx("div",{className:"error",children:"Pyodideロード中..."}),U&&t.jsxs("div",{className:"error",children:["エラー: ",U]}),t.jsxs("div",{className:"escher-panel",children:[t.jsx("h3",{children:"実行ステータス"}),t.jsxs("div",{className:"control",children:[t.jsx("span",{children:"status"}),t.jsx("input",{value:F,readOnly:!0})]}),h==="P2"&&t.jsx("p",{className:"escher-help",children:"P2は奇数が必要なため、偶数は+1して自動補正します。"})]})]}),t.jsxs("div",{className:"escher-tiling-panel",children:[t.jsxs("div",{className:"escher-tiling-header",children:[t.jsxs("div",{children:[t.jsx("h3",{children:"タイリング表示"}),t.jsx("p",{children:"右側キャンバスにエッシャー化結果を敷き詰めます。"})]}),O&&t.jsxs("div",{className:"tiling-stats",children:[t.jsxs("span",{children:["verts: ",O.triangulation.vertices.length]}),t.jsxs("span",{children:["tris: ",O.triangulation.faces.length]}),t.jsxs("span",{children:["tiles: ",w*X*L]})]})]}),t.jsxs("div",{ref:l,className:"tiling-canvas-wrap",children:[t.jsx("canvas",{ref:s,className:"tiling-canvas",onPointerDown:m=>{K.current={isDragging:!0,lastX:m.clientX,lastY:m.clientY},m.currentTarget.setPointerCapture(m.pointerId)},onPointerMove:m=>{if(!K.current.isDragging)return;const W=m.clientX-K.current.lastX,$=m.clientY-K.current.lastY;K.current.lastX=m.clientX,K.current.lastY=m.clientY,se(B=>({...B,panX:B.panX+W,panY:B.panY+$}))},onPointerUp:m=>{K.current.isDragging=!1,m.currentTarget.releasePointerCapture(m.pointerId)},onPointerLeave:()=>{K.current.isDragging=!1}}),!O&&t.jsx("div",{className:"tiling-empty",children:"画像を選択して「エッシャー化を実行」を押してください。"})]})]})]})]})}function Ge(i){const n=i.replace(/^#/,"");return n==="escherization-main"?"escherization-main":n==="contour-prep-test"?"contour-prep-test":n==="triangulation-test"?"triangulation-test":n==="arap-interactive-test"?"arap-interactive-test":n==="escherization-pipeline"?"escherization-pipeline":"home"}function Ht(){const[i,n]=f.useState(()=>Ge(window.location.hash));return f.useEffect(()=>{const r=()=>n(Ge(window.location.hash));return window.addEventListener("hashchange",r),()=>window.removeEventListener("hashchange",r)},[]),t.jsx("div",{className:"escher-shell",children:t.jsx("div",{className:"escher-layout",children:t.jsxs("main",{className:"escher-main",children:[i==="escherization-main"&&t.jsx(He,{}),i==="home"&&t.jsx(He,{}),i==="escherization-pipeline"&&t.jsx(It,{}),i==="contour-prep-test"&&t.jsx(ht,{}),i==="triangulation-test"&&t.jsx(zt,{}),i==="arap-interactive-test"&&t.jsx(Wt,{})]})})})}it.createRoot(document.getElementById("root")).render(t.jsx(f.StrictMode,{children:t.jsx(Ht,{})}));
