import"./modulepreload-polyfill-B5Qt9EMX.js";import{r as t,j as e,c as ne}from"./vendor-three-DWdYVK8p.js";import{u as te}from"./usePyodide-Bpngy5wJ.js";import{L as ae}from"./LinearMapVisualizer-t725-q9R.js";import"./vendor-react-CCYiWZgt.js";const re=2e4,ie=200,Y=[{id:"stem",label:"Stem",a:0,b:0,c:0,d:.16,e:0,f:0,p:.01},{id:"main",label:"Main",a:.85,b:.04,c:-.04,d:.85,e:0,f:1.6,p:.85},{id:"left",label:"Left Leaf",a:.2,b:-.26,c:.23,d:.22,e:0,f:1.6,p:.07},{id:"right",label:"Right Leaf",a:-.15,b:.28,c:.26,d:.24,e:0,f:.44,p:.07}];function A(o,L,c){return Math.min(c,Math.max(L,o))}function oe(){const[o,L]=t.useState(re),[c,k]=t.useState(ie),[b,G]=t.useState(42),[B,$]=t.useState(!1),[u,J]=t.useState(Y),[N,O]=t.useState(1),f=t.useRef(null),P=t.useRef(null),z=t.useRef(null),{pyodide:g,isReady:m,error:C}=te(["ifs_fern.py"]),v=t.useCallback(s=>{const a=z.current;if(!a)return;const l=a.getBoundingClientRect(),h=window.devicePixelRatio||1;a.width=Math.round(l.width*h),a.height=Math.round(l.height*h);const n=a.getContext("2d");if(!n)return;n.setTransform(1,0,0,1,0,0);const i=Math.max(1,Math.floor(a.width)),d=Math.max(1,Math.floor(a.height));n.fillStyle="#0b0f14",n.fillRect(0,0,i,d);const{xs:x,ys:j}=s;let S=1/0,w=-1/0,I=1/0,M=-1/0;for(let r=0;r<x.length;r+=1){const p=x[r],y=j[r];p<S&&(S=p),p>w&&(w=p),y<I&&(I=y),y>M&&(M=y)}const K=w-S||1,Q=M-I||1,W=i/K,Z=d/Q,U=Math.min(W,Z),ee=(S+w)/2,se=(I+M)/2,X=n.createImageData(i,d),R=X.data;for(let r=0;r<x.length;r+=1){const p=x[r],y=j[r],E=Math.round((p-ee)*U+i/2),F=Math.round(d/2-(y-se)*U);if(E<0||E>=i||F<0||F>=d)continue;const T=(F*i+E)*4;R[T]=110,R[T+1]=231,R[T+2]=156,R[T+3]=255}n.putImageData(X,0,0)},[]),D=t.useCallback(async()=>{if(!g||!m)return;$(!0);const s=A(o,1e4,3e5),a=A(c,1,500),l=A(b,0,1e6),h=u.map(n=>[n.a,n.b,n.c,n.d,n.e,n.f,n.p]);try{await g.runPythonAsync(`
import ifs_fern
transforms = ${JSON.stringify(h)}
xs, ys = ifs_fern.barnsley_fern(
    n=${s},
    burn_in=${a},
    seed=${l},
    transforms=transforms,
)
xs_list = xs
ys_list = ys
      `);const n=g.globals.get("xs_list").toJs(),i=g.globals.get("ys_list").toJs(),d=Array.from(n),x=Array.from(i),j={xs:d,ys:x};P.current=j,v(j)}catch(n){console.error("IFS fern generation failed:",n)}finally{$(!1)}},[g,m,o,c,b,u,v]);t.useEffect(()=>{m&&(f.current!==null&&window.clearTimeout(f.current),f.current=window.setTimeout(()=>{D(),f.current=null},250))},[c,D,m,o,b,u]),t.useEffect(()=>{const s=()=>{P.current&&v(P.current)};return window.addEventListener("resize",s),()=>{window.removeEventListener("resize",s),f.current!==null&&window.clearTimeout(f.current)}},[v]);const V=t.useMemo(()=>C?`Pyodide load error: ${C}`:m?B?"Generating fern...":"Auto-updated":"Pyodide loading...",[B,m,C]),_=u[N]??u[0],q=t.useMemo(()=>{const s=_??Y[0];return{v1:{x:s.a,y:s.c},v2:{x:s.b,y:s.d},translation:{x:s.e,y:s.f}}},[_]),H=t.useCallback(s=>{J(a=>a.map((l,h)=>h!==N?l:{...l,a:s.v1.x,b:s.v2.x,c:s.v1.y,d:s.v2.y,e:s.translation.x,f:s.translation.y}))},[N]);return e.jsxs("div",{className:"app-container",children:[e.jsx("header",{className:"app-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"eyebrow",children:"IFS Playground"}),e.jsx("h1",{children:"Barnsley Fern"}),e.jsx("p",{className:"subtitle",children:"Pyodide上のPythonでIFSを計算し、キャンバスに描画します。"})]})}),e.jsxs("div",{className:"app-body",children:[e.jsxs("section",{className:"canvas-panel",children:[e.jsx("div",{className:"canvas-frame",children:e.jsx("canvas",{ref:z,className:"fern-canvas"})}),e.jsx("p",{className:"status",children:V})]}),e.jsx("aside",{className:"controls-panel",children:e.jsxs("div",{className:"control-card",children:[e.jsx("h2",{children:"Parameters"}),e.jsxs("label",{className:"control",children:[e.jsx("span",{children:"Points"}),e.jsx("input",{type:"range",min:1e4,max:3e4,step:1e3,value:o,onChange:s=>L(Number(s.target.value))}),e.jsx("span",{className:"value",children:o.toLocaleString()})]}),e.jsxs("label",{className:"control",children:[e.jsx("span",{children:"Burn-in"}),e.jsx("input",{type:"range",min:0,max:500,step:10,value:c,onChange:s=>k(Number(s.target.value))}),e.jsx("span",{className:"value",children:c.toLocaleString()})]}),e.jsxs("label",{className:"control",children:[e.jsx("span",{children:"Seed"}),e.jsx("input",{type:"number",min:0,max:1e6,value:b,onChange:s=>G(Number(s.target.value))})]}),e.jsx("p",{className:"hint",children:"値を変えると自動で再計算します。"})]})})]}),e.jsxs("section",{className:"transform-editor",children:[e.jsxs("div",{className:"transform-list",children:[e.jsx("h2",{children:"IFS Maps"}),e.jsx("p",{className:"hint",children:"編集したい写像を選んで、右の線型写像UIで調整します。"}),e.jsx("div",{className:"transform-buttons",children:u.map((s,a)=>e.jsxs("button",{className:`transform-button ${a===N?"is-active":""}`,onClick:()=>O(a),type:"button",children:[e.jsx("span",{children:s.label}),e.jsxs("span",{className:"probability",children:["p=",s.p.toFixed(2)]})]},s.id))})]}),e.jsx("div",{className:"transform-visualizer",children:_&&e.jsx(ae,{value:q,onChange:H,showReset:!1})})]})]})}ne.createRoot(document.getElementById("root")).render(e.jsx(t.StrictMode,{children:e.jsx(oe,{})}));
