import"./modulepreload-polyfill-B5Qt9EMX.js";import{r as f,j as t,c as at}from"./vendor-three-DWdYVK8p.js";import{u as Ze}from"./usePyodide-Bpngy5wJ.js";import"./vendor-react-CCYiWZgt.js";const ot={simplifyRatio:.008,theta1:0,theta2:Math.PI/2,alphaThreshold:128,grayscaleThreshold:250,maxDimension:2048,timeoutMs:9e4};async function me(i){const n=await createImageBitmap(i);return Se(n)}function Se(i){const n=document.createElement("canvas");n.width=i.width,n.height=i.height;const r=n.getContext("2d",{willReadFrequently:!0});if(!r)throw new Error("Failed to get 2D context");return r.drawImage(i,0,0),r.getImageData(0,0,i.width,i.height)}let ue=null,lt=1;const Me=new Map;function ct(){if(ue)return ue;const i=new Worker(new URL("/my-site/python-apps/assets/prepareContourWorker-CBYGSW13.js",import.meta.url),{type:"module"});return i.onmessage=n=>{const r=n.data,e=Me.get(r.id);e&&(Me.delete(r.id),r.type==="error"?e.reject(new Error(r.message)):e.resolve(r))},i.onerror=n=>{console.error("prepareContourWorker error",n)},ue=i,ue}function ut(){ue&&ue.terminate(),ue=null}async function xe(i,n={}){const r={...ot,...n},e=lt++,s=ct(),l=i.width,u=i.height,x=new Uint8ClampedArray(i.data).buffer,M={id:e,type:"process",width:l,height:u,buffer:x,options:{simplifyRatio:r.simplifyRatio,theta1:r.theta1,theta2:r.theta2,alphaThreshold:r.alphaThreshold,grayscaleThreshold:r.grayscaleThreshold,maxDimension:r.maxDimension}},p=new Promise((b,R)=>{Me.set(e,{resolve:b,reject:R}),s.postMessage(M,[x])}),m=new Promise((b,R)=>{const T=window.setTimeout(()=>{ut(),R(new Error(`prepareContourForEscherization timed out after ${r.timeoutMs}ms`))},r.timeoutMs);p.finally(()=>window.clearTimeout(T))}),h=await Promise.race([p,m]);if(h.type!=="result")throw new Error("Unexpected worker response");return{contour:ht(h.contour),imageData:i,tranU:h.tranU,tranV:h.tranV}}function ht(i){return dt(i)<0?i.slice().reverse():i.slice()}function dt(i){let n=0;const r=i.length;for(let e=0;e<r;e++){const s=(e+1)%r;n+=i[e][0]*i[s][1]-i[s][0]*i[e][1]}return n}function ft(){const[i,n]=f.useState(null),[r,e]=f.useState(.008),[s,l]=f.useState(0),[u,d]=f.useState(90),[x,M]=f.useState(9e4),[p,m]=f.useState(null),[h,j]=f.useState(null),[b,R]=f.useState(!1),T=f.useRef(null),y=f.useMemo(()=>s*Math.PI/180,[s]),_=f.useMemo(()=>u*Math.PI/180,[u]),L=f.useCallback(A=>{const E=T.current;if(!E)return;const N=E.getContext("2d");if(!N)return;E.width=A.imageData.width,E.height=A.imageData.height,N.putImageData(A.imageData,0,0);const W=A.contour;if(!(W.length<2)){N.save(),N.lineWidth=Math.max(1,Math.floor(Math.min(E.width,E.height)/400)),N.strokeStyle="rgba(255, 0, 0, 0.9)",N.beginPath(),N.moveTo(W[0][0],W[0][1]);for(let B=1;B<W.length;B++)N.lineTo(W[B][0],W[B][1]);N.closePath(),N.stroke(),N.restore()}},[]),J=f.useCallback(async()=>{if(i){R(!0),j(null),m(null);try{const A=await me(i);console.log("Loaded image:",A.width,"x",A.height);const E=await xe(A,{simplifyRatio:r,theta1:y,theta2:_,timeoutMs:x});console.log("Prepared contour:",E),m(E),L(E)}catch(A){console.error("Contour prep failed:",A),j(A instanceof Error?A.message:String(A))}finally{R(!1)}}},[L,i,r,y,_,x]);return t.jsxs("section",{children:[t.jsx("h2",{children:"prepare_contour_for_escherization (Test)"}),t.jsx("p",{children:"画像から輪郭抽出→CCW統一→平行四辺形ベクトル算出（Web Worker + d3-contour使用）"}),t.jsxs("div",{className:"escher-controls",children:[t.jsxs("label",{className:"control",children:[t.jsx("span",{children:"画像ファイル"}),t.jsx("input",{type:"file",accept:"image/*",onChange:A=>n(A.target.files?.[0]??null)})]}),t.jsxs("div",{className:"controls-row",children:[t.jsxs("label",{className:"control",children:[t.jsx("span",{children:"simplifyRatio"}),t.jsx("input",{type:"number",step:"0.001",min:"0",value:r,onChange:A=>e(Number(A.target.value))})]}),t.jsxs("label",{className:"control",children:[t.jsx("span",{children:"theta1 (deg)"}),t.jsx("input",{type:"number",step:"1",value:s,onChange:A=>l(Number(A.target.value))})]}),t.jsxs("label",{className:"control",children:[t.jsx("span",{children:"theta2 (deg)"}),t.jsx("input",{type:"number",step:"1",value:u,onChange:A=>d(Number(A.target.value))})]}),t.jsxs("label",{className:"control",children:[t.jsx("span",{children:"timeout (ms)"}),t.jsx("input",{type:"number",step:"1000",min:"1000",value:x,onChange:A=>M(Number(A.target.value))})]}),t.jsx("button",{className:"run-button",onClick:J,disabled:!i||b,children:b?"処理中...":"実行"})]}),h&&t.jsxs("div",{className:"error",children:["エラー: ",h]})]}),t.jsxs("div",{className:"escher-output",children:[t.jsx("div",{className:"canvas-wrap",children:t.jsx("canvas",{ref:T})}),t.jsxs("div",{className:"stats",children:[t.jsx("h3",{children:"結果"}),p?t.jsxs("dl",{children:[t.jsxs("div",{className:"kv",children:[t.jsx("dt",{children:"contour points"}),t.jsx("dd",{children:p.contour.length})]}),t.jsxs("div",{className:"kv",children:[t.jsx("dt",{children:"image size"}),t.jsxs("dd",{children:[p.imageData.width," × ",p.imageData.height]})]}),t.jsxs("div",{className:"kv",children:[t.jsx("dt",{children:"tran_u"}),t.jsxs("dd",{children:["(",p.tranU[0].toFixed(2),", ",p.tranU[1].toFixed(2),")"]})]}),t.jsxs("div",{className:"kv",children:[t.jsx("dt",{children:"tran_v"}),t.jsxs("dd",{children:["(",p.tranV[0].toFixed(2),", ",p.tranV[1].toFixed(2),")"]})]})]}):t.jsx("p",{children:"画像を選んで「実行」を押してください。"})]})]})]})}var ve={};const pt="1.5.0",gt={version:pt};var ye,Re;function Te(){if(Re)return ye;Re=1;function i(s){return"("+s.x+";"+s.y+")"}function n(s){var l=s.toString();return l==="[object Object]"?i(s):l}function r(s,l){return s.y===l.y?s.x-l.x:s.y-l.y}function e(s,l){return s.x===l.x&&s.y===l.y}return ye={toString:n,toStringBase:i,compare:r,equals:e},ye}var be,We;function Ae(){if(We)return be;We=1;var i=Te(),n=function(r,e){this.name="PointError",this.points=e=e||[],this.message=r||"Invalid Points!";for(var s=0;s<e.length;s++)this.message+=" "+i.toString(e[s])};return n.prototype=new Error,n.prototype.constructor=n,be=n,be}var _e,ze;function Qe(){if(ze)return _e;ze=1;var i=Te(),n=function(r,e){this.x=+r||0,this.y=+e||0,this._p2t_edge_list=null};return n.prototype.toString=function(){return i.toStringBase(this)},n.prototype.toJSON=function(){return{x:this.x,y:this.y}},n.prototype.clone=function(){return new n(this.x,this.y)},n.prototype.set_zero=function(){return this.x=0,this.y=0,this},n.prototype.set=function(r,e){return this.x=+r||0,this.y=+e||0,this},n.prototype.negate=function(){return this.x=-this.x,this.y=-this.y,this},n.prototype.add=function(r){return this.x+=r.x,this.y+=r.y,this},n.prototype.sub=function(r){return this.x-=r.x,this.y-=r.y,this},n.prototype.mul=function(r){return this.x*=r,this.y*=r,this},n.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},n.prototype.normalize=function(){var r=this.length();return this.x/=r,this.y/=r,r},n.prototype.equals=function(r){return this.x===r.x&&this.y===r.y},n.negate=function(r){return new n(-r.x,-r.y)},n.add=function(r,e){return new n(r.x+e.x,r.y+e.y)},n.sub=function(r,e){return new n(r.x-e.x,r.y-e.y)},n.mul=function(r,e){return new n(r*e.x,r*e.y)},n.cross=function(r,e){return typeof r=="number"?typeof e=="number"?r*e:new n(-r*e.y,r*e.x):typeof e=="number"?new n(e*r.y,-e*r.x):r.x*e.y-r.y*e.x},n.toString=i.toString,n.compare=i.compare,n.cmp=i.compare,n.equals=i.equals,n.dot=function(r,e){return r.x*e.x+r.y*e.y},_e=n,_e}var je,De;function Ie(){if(De)return je;De=1;var i=Te(),n=function(e,s,l){this.points_=[e,s,l],this.neighbors_=[null,null,null],this.interior_=!1,this.constrained_edge=[!1,!1,!1],this.delaunay_edge=[!1,!1,!1]},r=i.toString;return n.prototype.toString=function(){return"["+r(this.points_[0])+r(this.points_[1])+r(this.points_[2])+"]"},n.prototype.getPoint=function(e){return this.points_[e]},n.prototype.GetPoint=n.prototype.getPoint,n.prototype.getPoints=function(){return this.points_},n.prototype.getNeighbor=function(e){return this.neighbors_[e]},n.prototype.containsPoint=function(e){var s=this.points_;return e===s[0]||e===s[1]||e===s[2]},n.prototype.containsEdge=function(e){return this.containsPoint(e.p)&&this.containsPoint(e.q)},n.prototype.containsPoints=function(e,s){return this.containsPoint(e)&&this.containsPoint(s)},n.prototype.isInterior=function(){return this.interior_},n.prototype.setInterior=function(e){return this.interior_=e,this},n.prototype.markNeighborPointers=function(e,s,l){var u=this.points_;if(e===u[2]&&s===u[1]||e===u[1]&&s===u[2])this.neighbors_[0]=l;else if(e===u[0]&&s===u[2]||e===u[2]&&s===u[0])this.neighbors_[1]=l;else if(e===u[0]&&s===u[1]||e===u[1]&&s===u[0])this.neighbors_[2]=l;else throw new Error("poly2tri Invalid Triangle.markNeighborPointers() call")},n.prototype.markNeighbor=function(e){var s=this.points_;e.containsPoints(s[1],s[2])?(this.neighbors_[0]=e,e.markNeighborPointers(s[1],s[2],this)):e.containsPoints(s[0],s[2])?(this.neighbors_[1]=e,e.markNeighborPointers(s[0],s[2],this)):e.containsPoints(s[0],s[1])&&(this.neighbors_[2]=e,e.markNeighborPointers(s[0],s[1],this))},n.prototype.clearNeighbors=function(){this.neighbors_[0]=null,this.neighbors_[1]=null,this.neighbors_[2]=null},n.prototype.clearDelaunayEdges=function(){this.delaunay_edge[0]=!1,this.delaunay_edge[1]=!1,this.delaunay_edge[2]=!1},n.prototype.pointCW=function(e){var s=this.points_;return e===s[0]?s[2]:e===s[1]?s[0]:e===s[2]?s[1]:null},n.prototype.pointCCW=function(e){var s=this.points_;return e===s[0]?s[1]:e===s[1]?s[2]:e===s[2]?s[0]:null},n.prototype.neighborCW=function(e){return e===this.points_[0]?this.neighbors_[1]:e===this.points_[1]?this.neighbors_[2]:this.neighbors_[0]},n.prototype.neighborCCW=function(e){return e===this.points_[0]?this.neighbors_[2]:e===this.points_[1]?this.neighbors_[0]:this.neighbors_[1]},n.prototype.getConstrainedEdgeCW=function(e){return e===this.points_[0]?this.constrained_edge[1]:e===this.points_[1]?this.constrained_edge[2]:this.constrained_edge[0]},n.prototype.getConstrainedEdgeCCW=function(e){return e===this.points_[0]?this.constrained_edge[2]:e===this.points_[1]?this.constrained_edge[0]:this.constrained_edge[1]},n.prototype.getConstrainedEdgeAcross=function(e){return e===this.points_[0]?this.constrained_edge[0]:e===this.points_[1]?this.constrained_edge[1]:this.constrained_edge[2]},n.prototype.setConstrainedEdgeCW=function(e,s){e===this.points_[0]?this.constrained_edge[1]=s:e===this.points_[1]?this.constrained_edge[2]=s:this.constrained_edge[0]=s},n.prototype.setConstrainedEdgeCCW=function(e,s){e===this.points_[0]?this.constrained_edge[2]=s:e===this.points_[1]?this.constrained_edge[0]=s:this.constrained_edge[1]=s},n.prototype.getDelaunayEdgeCW=function(e){return e===this.points_[0]?this.delaunay_edge[1]:e===this.points_[1]?this.delaunay_edge[2]:this.delaunay_edge[0]},n.prototype.getDelaunayEdgeCCW=function(e){return e===this.points_[0]?this.delaunay_edge[2]:e===this.points_[1]?this.delaunay_edge[0]:this.delaunay_edge[1]},n.prototype.setDelaunayEdgeCW=function(e,s){e===this.points_[0]?this.delaunay_edge[1]=s:e===this.points_[1]?this.delaunay_edge[2]=s:this.delaunay_edge[0]=s},n.prototype.setDelaunayEdgeCCW=function(e,s){e===this.points_[0]?this.delaunay_edge[2]=s:e===this.points_[1]?this.delaunay_edge[0]=s:this.delaunay_edge[1]=s},n.prototype.neighborAcross=function(e){return e===this.points_[0]?this.neighbors_[0]:e===this.points_[1]?this.neighbors_[1]:this.neighbors_[2]},n.prototype.oppositePoint=function(e,s){var l=e.pointCW(s);return this.pointCW(l)},n.prototype.legalize=function(e,s){var l=this.points_;if(e===l[0])l[1]=l[0],l[0]=l[2],l[2]=s;else if(e===l[1])l[2]=l[1],l[1]=l[0],l[0]=s;else if(e===l[2])l[0]=l[2],l[2]=l[1],l[1]=s;else throw new Error("poly2tri Invalid Triangle.legalize() call")},n.prototype.index=function(e){var s=this.points_;if(e===s[0])return 0;if(e===s[1])return 1;if(e===s[2])return 2;throw new Error("poly2tri Invalid Triangle.index() call")},n.prototype.edgeIndex=function(e,s){var l=this.points_;if(e===l[0]){if(s===l[1])return 2;if(s===l[2])return 1}else if(e===l[1]){if(s===l[2])return 0;if(s===l[0])return 2}else if(e===l[2]){if(s===l[0])return 1;if(s===l[1])return 0}return-1},n.prototype.markConstrainedEdgeByIndex=function(e){this.constrained_edge[e]=!0},n.prototype.markConstrainedEdgeByEdge=function(e){this.markConstrainedEdgeByPoints(e.p,e.q)},n.prototype.markConstrainedEdgeByPoints=function(e,s){var l=this.points_;s===l[0]&&e===l[1]||s===l[1]&&e===l[0]?this.constrained_edge[2]=!0:s===l[0]&&e===l[2]||s===l[2]&&e===l[0]?this.constrained_edge[1]=!0:(s===l[1]&&e===l[2]||s===l[2]&&e===l[1])&&(this.constrained_edge[0]=!0)},je=n,je}var Ce={},we,Be;function mt(){if(Be)return we;Be=1;function i(n,r){if(!n)throw new Error(r||"Assert Failed")}return we=i,we}var ge={exports:{}},$e;function et(){if($e)return ge.exports;$e=1;var i=function(r,e){this.point=r,this.triangle=e||null,this.next=null,this.prev=null,this.value=r.x},n=function(r,e){this.head_=r,this.tail_=e,this.search_node_=r};return n.prototype.head=function(){return this.head_},n.prototype.setHead=function(r){this.head_=r},n.prototype.tail=function(){return this.tail_},n.prototype.setTail=function(r){this.tail_=r},n.prototype.search=function(){return this.search_node_},n.prototype.setSearch=function(r){this.search_node_=r},n.prototype.findSearchNode=function(){return this.search_node_},n.prototype.locateNode=function(r){var e=this.search_node_;if(r<e.value){for(;e=e.prev;)if(r>=e.value)return this.search_node_=e,e}else for(;e=e.next;)if(r<e.value)return this.search_node_=e.prev,e.prev;return null},n.prototype.locatePoint=function(r){var e=r.x,s=this.findSearchNode(e),l=s.point.x;if(e===l){if(r!==s.point)if(r===s.prev.point)s=s.prev;else if(r===s.next.point)s=s.next;else throw new Error("poly2tri Invalid AdvancingFront.locatePoint() call")}else if(e<l)for(;(s=s.prev)&&r!==s.point;);else for(;(s=s.next)&&r!==s.point;);return s&&(this.search_node_=s),s},ge.exports=n,ge.exports.Node=i,ge.exports}var ce={},Fe;function xt(){if(Fe)return ce;Fe=1;var i=1e-12;ce.EPSILON=i;var n={CW:1,CCW:-1,COLLINEAR:0};ce.Orientation=n;function r(l,u,d){var x=(l.x-d.x)*(u.y-d.y),M=(l.y-d.y)*(u.x-d.x),p=x-M;return p>-i&&p<i?n.COLLINEAR:p>0?n.CCW:n.CW}ce.orient2d=r;function e(l,u,d,x){var M=(l.x-u.x)*(x.y-u.y)-(x.x-u.x)*(l.y-u.y);if(M>=-i)return!1;var p=(l.x-d.x)*(x.y-d.y)-(x.x-d.x)*(l.y-d.y);return!(p<=i)}ce.inScanArea=e;function s(l,u,d){var x=u.x-l.x,M=u.y-l.y,p=d.x-l.x,m=d.y-l.y;return x*p+M*m<0}return ce.isAngleObtuse=s,ce}var Oe;function tt(){if(Oe)return Ce;Oe=1;var i=mt(),n=Ae(),r=Ie(),e=et().Node,s=xt(),l=s.EPSILON,u=s.Orientation,d=s.orient2d,x=s.inScanArea,M=s.isAngleObtuse;function p(c){c.initTriangulation(),c.createAdvancingFront(),m(c),h(c)}function m(c){var a,o=c.pointCount();for(a=1;a<o;++a)for(var g=c.getPoint(a),C=j(c,g),S=g._p2t_edge_list,I=0;S&&I<S.length;++I)b(c,S[I],C)}function h(c){for(var a=c.front().head().next.triangle,o=c.front().head().next.point;!a.getConstrainedEdgeCW(o);)a=a.neighborCCW(o);c.meshClean(a)}function j(c,a){var o=c.locateNode(a),g=y(c,a,o);return a.x<=o.point.x+l&&_(c,o),L(c,g),g}function b(c,a,o){c.edge_event.constrained_edge=a,c.edge_event.right=a.p.x>a.q.x,!T(o.triangle,a.p,a.q)&&(q(c,a,o),R(c,a.p,a.q,o.triangle,a.q))}function R(c,a,o,g,C){if(!T(g,a,o)){var S=g.pointCCW(C),I=d(o,S,a);if(I===u.COLLINEAR)throw new n("poly2tri EdgeEvent: Collinear not supported!",[o,S,a]);var V=g.pointCW(C),w=d(o,V,a);if(w===u.COLLINEAR)throw new n("poly2tri EdgeEvent: Collinear not supported!",[o,V,a]);I===w?(I===u.CW?g=g.neighborCCW(C):g=g.neighborCW(C),R(c,a,o,g,C)):ne(c,a,o,g,C)}}function T(c,a,o){var g=c.edgeIndex(a,o);if(g!==-1){c.markConstrainedEdgeByIndex(g);var C=c.getNeighbor(g);return C&&C.markConstrainedEdgeByPoints(a,o),!0}return!1}function y(c,a,o){var g=new r(a,o.point,o.next.point);g.markNeighbor(o.triangle),c.addToMap(g);var C=new e(a);return C.next=o.next,C.prev=o,o.next.prev=C,o.next=C,A(c,g)||c.mapTriangleToNodes(g),C}function _(c,a){var o=new r(a.prev.point,a.point,a.next.point);o.markNeighbor(a.prev.triangle),o.markNeighbor(a.triangle),c.addToMap(o),a.prev.next=a.next,a.next.prev=a.prev,A(c,o)||c.mapTriangleToNodes(o)}function L(c,a){for(var o=a.next;o.next&&!M(o.point,o.next.point,o.prev.point);)_(c,o),o=o.next;for(o=a.prev;o.prev&&!M(o.point,o.next.point,o.prev.point);)_(c,o),o=o.prev;a.next&&a.next.next&&J(a)&&W(c,a)}function J(c){var a=c.point.x-c.next.next.point.x,o=c.point.y-c.next.next.point.y;return i(o>=0,"unordered y"),a>=0||Math.abs(a)<o}function A(c,a){for(var o=0;o<3;++o)if(!a.delaunay_edge[o]){var g=a.getNeighbor(o);if(g){var C=a.getPoint(o),S=g.oppositePoint(a,C),I=g.index(S);if(g.constrained_edge[I]||g.delaunay_edge[I]){a.constrained_edge[o]=g.constrained_edge[I];continue}var V=E(C,a.pointCCW(C),a.pointCW(C),S);if(V){a.delaunay_edge[o]=!0,g.delaunay_edge[I]=!0,N(a,C,g,S);var w=!A(c,a);return w&&c.mapTriangleToNodes(a),w=!A(c,g),w&&c.mapTriangleToNodes(g),a.delaunay_edge[o]=!1,g.delaunay_edge[I]=!1,!0}}}return!1}function E(c,a,o,g){var C=c.x-g.x,S=c.y-g.y,I=a.x-g.x,V=a.y-g.y,w=C*V,O=I*S,F=w-O;if(F<=0)return!1;var U=o.x-g.x,v=o.y-g.y,D=U*S,P=C*v,X=D-P;if(X<=0)return!1;var Q=I*v,re=U*V,se=C*C+S*S,de=I*I+V*V,oe=U*U+v*v,le=se*(Q-re)+de*X+oe*F;return le>0}function N(c,a,o,g){var C,S,I,V;C=c.neighborCCW(a),S=c.neighborCW(a),I=o.neighborCCW(g),V=o.neighborCW(g);var w,O,F,U;w=c.getConstrainedEdgeCCW(a),O=c.getConstrainedEdgeCW(a),F=o.getConstrainedEdgeCCW(g),U=o.getConstrainedEdgeCW(g);var v,D,P,X;v=c.getDelaunayEdgeCCW(a),D=c.getDelaunayEdgeCW(a),P=o.getDelaunayEdgeCCW(g),X=o.getDelaunayEdgeCW(g),c.legalize(a,g),o.legalize(g,a),o.setDelaunayEdgeCCW(a,v),c.setDelaunayEdgeCW(a,D),c.setDelaunayEdgeCCW(g,P),o.setDelaunayEdgeCW(g,X),o.setConstrainedEdgeCCW(a,w),c.setConstrainedEdgeCW(a,O),c.setConstrainedEdgeCCW(g,F),o.setConstrainedEdgeCW(g,U),c.clearNeighbors(),o.clearNeighbors(),C&&o.markNeighbor(C),S&&c.markNeighbor(S),I&&c.markNeighbor(I),V&&o.markNeighbor(V),c.markNeighbor(o)}function W(c,a){for(d(a.point,a.next.point,a.next.next.point)===u.CCW?c.basin.left_node=a.next.next:c.basin.left_node=a.next,c.basin.bottom_node=c.basin.left_node;c.basin.bottom_node.next&&c.basin.bottom_node.point.y>=c.basin.bottom_node.next.point.y;)c.basin.bottom_node=c.basin.bottom_node.next;if(c.basin.bottom_node!==c.basin.left_node){for(c.basin.right_node=c.basin.bottom_node;c.basin.right_node.next&&c.basin.right_node.point.y<c.basin.right_node.next.point.y;)c.basin.right_node=c.basin.right_node.next;c.basin.right_node!==c.basin.bottom_node&&(c.basin.width=c.basin.right_node.point.x-c.basin.left_node.point.x,c.basin.left_highest=c.basin.left_node.point.y>c.basin.right_node.point.y,B(c,c.basin.bottom_node))}}function B(c,a){if(!k(c,a)){_(c,a);var o;if(!(a.prev===c.basin.left_node&&a.next===c.basin.right_node)){if(a.prev===c.basin.left_node){if(o=d(a.point,a.next.point,a.next.next.point),o===u.CW)return;a=a.next}else if(a.next===c.basin.right_node){if(o=d(a.point,a.prev.point,a.prev.prev.point),o===u.CCW)return;a=a.prev}else a.prev.point.y<a.next.point.y?a=a.prev:a=a.next;B(c,a)}}}function k(c,a){var o;return c.basin.left_highest?o=c.basin.left_node.point.y-a.point.y:o=c.basin.right_node.point.y-a.point.y,c.basin.width>o}function q(c,a,o){c.edge_event.right?Y(c,a,o):ee(c,a,o)}function Y(c,a,o){for(;o.next.point.x<a.p.x;)d(a.q,o.next.point,a.p)===u.CCW?K(c,a,o):o=o.next}function K(c,a,o){o.point.x<a.p.x&&(d(o.point,o.next.point,o.next.next.point)===u.CCW?Z(c,a,o):($(c,a,o),K(c,a,o)))}function Z(c,a,o){_(c,o.next),o.next.point!==a.p&&d(a.q,o.next.point,a.p)===u.CCW&&d(o.point,o.next.point,o.next.next.point)===u.CCW&&Z(c,a,o)}function $(c,a,o){d(o.next.point,o.next.next.point,o.next.next.next.point)===u.CCW?Z(c,a,o.next):d(a.q,o.next.next.point,a.p)===u.CCW&&$(c,a,o.next)}function ee(c,a,o){for(;o.prev.point.x>a.p.x;)d(a.q,o.prev.point,a.p)===u.CW?H(c,a,o):o=o.prev}function H(c,a,o){o.point.x>a.p.x&&(d(o.point,o.prev.point,o.prev.prev.point)===u.CW?z(c,a,o):(ie(c,a,o),H(c,a,o)))}function ie(c,a,o){d(o.prev.point,o.prev.prev.point,o.prev.prev.prev.point)===u.CW?z(c,a,o.prev):d(a.q,o.prev.prev.point,a.p)===u.CW&&ie(c,a,o.prev)}function z(c,a,o){_(c,o.prev),o.prev.point!==a.p&&d(a.q,o.prev.point,a.p)===u.CW&&d(o.point,o.prev.point,o.prev.prev.point)===u.CW&&z(c,a,o)}function ne(c,a,o,g,C){var S=g.neighborAcross(C);i(S,"FLIP failed due to missing triangle!");var I=S.oppositePoint(g,C);if(g.getConstrainedEdgeAcross(C)){var V=g.index(C);throw new n("poly2tri Intersecting Constraints",[C,I,g.getPoint((V+1)%3),g.getPoint((V+2)%3)])}if(x(C,g.pointCCW(C),g.pointCW(C),I))if(N(g,C,S,I),c.mapTriangleToNodes(g),c.mapTriangleToNodes(S),C===o&&I===a)o===c.edge_event.constrained_edge.q&&a===c.edge_event.constrained_edge.p&&(g.markConstrainedEdgeByPoints(a,o),S.markConstrainedEdgeByPoints(a,o),A(c,g),A(c,S));else{var w=d(o,I,a);g=G(c,w,g,S,C,I),ne(c,a,o,g,C)}else{var O=ae(a,o,S,I);te(c,a,o,g,S,O),R(c,a,o,g,C)}}function G(c,a,o,g,C,S){var I;return a===u.CCW?(I=g.edgeIndex(C,S),g.delaunay_edge[I]=!0,A(c,g),g.clearDelaunayEdges(),o):(I=o.edgeIndex(C,S),o.delaunay_edge[I]=!0,A(c,o),o.clearDelaunayEdges(),g)}function ae(c,a,o,g){var C=d(a,g,c);if(C===u.CW)return o.pointCCW(g);if(C===u.CCW)return o.pointCW(g);throw new n("poly2tri [Unsupported] nextFlipPoint: opposing point on constrained edge!",[a,g,c])}function te(c,a,o,g,C,S){var I=C.neighborAcross(S);i(I,"FLIP failed due to missing triangle");var V=I.oppositePoint(C,S);if(x(o,g.pointCCW(o),g.pointCW(o),V))ne(c,o,V,I,V);else{var w=ae(a,o,I,V);te(c,a,o,g,I,w)}}return Ce.triangulate=p,Ce}var Ne,Ue;function vt(){if(Ue)return Ne;Ue=1;var i=Ae(),n=Qe(),r=Ie(),e=tt(),s=et(),l=s.Node,u=.3,d=function(m,h){if(this.p=m,this.q=h,m.y>h.y)this.q=m,this.p=h;else if(m.y===h.y){if(m.x>h.x)this.q=m,this.p=h;else if(m.x===h.x)throw new i("poly2tri Invalid Edge constructor: repeated points!",[m])}this.q._p2t_edge_list||(this.q._p2t_edge_list=[]),this.q._p2t_edge_list.push(this)},x=function(){this.left_node=null,this.bottom_node=null,this.right_node=null,this.width=0,this.left_highest=!1};x.prototype.clear=function(){this.left_node=null,this.bottom_node=null,this.right_node=null,this.width=0,this.left_highest=!1};var M=function(){this.constrained_edge=null,this.right=!1},p=function(m,h){h=h||{},this.triangles_=[],this.map_=[],this.points_=h.cloneArrays?m.slice(0):m,this.edge_list=[],this.pmin_=this.pmax_=null,this.front_=null,this.head_=null,this.tail_=null,this.af_head_=null,this.af_middle_=null,this.af_tail_=null,this.basin=new x,this.edge_event=new M,this.initEdges(this.points_)};return p.prototype.addHole=function(m){this.initEdges(m);var h,j=m.length;for(h=0;h<j;h++)this.points_.push(m[h]);return this},p.prototype.AddHole=p.prototype.addHole,p.prototype.addHoles=function(m){var h,j=m.length;for(h=0;h<j;h++)this.initEdges(m[h]);return this.points_=this.points_.concat.apply(this.points_,m),this},p.prototype.addPoint=function(m){return this.points_.push(m),this},p.prototype.AddPoint=p.prototype.addPoint,p.prototype.addPoints=function(m){return this.points_=this.points_.concat(m),this},p.prototype.triangulate=function(){return e.triangulate(this),this},p.prototype.getBoundingBox=function(){return{min:this.pmin_,max:this.pmax_}},p.prototype.getTriangles=function(){return this.triangles_},p.prototype.GetTriangles=p.prototype.getTriangles,p.prototype.front=function(){return this.front_},p.prototype.pointCount=function(){return this.points_.length},p.prototype.head=function(){return this.head_},p.prototype.setHead=function(m){this.head_=m},p.prototype.tail=function(){return this.tail_},p.prototype.setTail=function(m){this.tail_=m},p.prototype.getMap=function(){return this.map_},p.prototype.initTriangulation=function(){var m=this.points_[0].x,h=this.points_[0].x,j=this.points_[0].y,b=this.points_[0].y,R,T=this.points_.length;for(R=1;R<T;R++){var y=this.points_[R];y.x>m&&(m=y.x),y.x<h&&(h=y.x),y.y>j&&(j=y.y),y.y<b&&(b=y.y)}this.pmin_=new n(h,b),this.pmax_=new n(m,j);var _=u*(m-h),L=u*(j-b);this.head_=new n(m+_,b-L),this.tail_=new n(h-_,b-L),this.points_.sort(n.compare)},p.prototype.initEdges=function(m){var h,j=m.length;for(h=0;h<j;++h)this.edge_list.push(new d(m[h],m[(h+1)%j]))},p.prototype.getPoint=function(m){return this.points_[m]},p.prototype.addToMap=function(m){this.map_.push(m)},p.prototype.locateNode=function(m){return this.front_.locateNode(m.x)},p.prototype.createAdvancingFront=function(){var m,h,j,b=new r(this.points_[0],this.tail_,this.head_);this.map_.push(b),m=new l(b.getPoint(1),b),h=new l(b.getPoint(0),b),j=new l(b.getPoint(2)),this.front_=new s(m,j),m.next=h,h.next=j,h.prev=m,j.prev=h},p.prototype.removeNode=function(m){},p.prototype.mapTriangleToNodes=function(m){for(var h=0;h<3;++h)if(!m.getNeighbor(h)){var j=this.front_.locatePoint(m.pointCW(m.getPoint(h)));j&&(j.triangle=m)}},p.prototype.removeFromMap=function(m){var h,j=this.map_,b=j.length;for(h=0;h<b;h++)if(j[h]===m){j.splice(h,1);break}},p.prototype.meshClean=function(m){for(var h=[m],j,b;j=h.pop();)if(!j.isInterior())for(j.setInterior(!0),this.triangles_.push(j),b=0;b<3;b++)j.constrained_edge[b]||h.push(j.getNeighbor(b))},Ne=p,Ne}var Xe;function yt(){return Xe||(Xe=1,(function(i){var n=globalThis.poly2tri;i.noConflict=function(){return globalThis.poly2tri=n,i},i.VERSION=gt.version,i.PointError=Ae(),i.Point=Qe(),i.Triangle=Ie(),i.SweepContext=vt();var r=tt();i.triangulate=r.triangulate,i.sweep={Triangulate:r.triangulate}})(ve)),ve}var Pe=yt();function ke(i,n={}){const r=bt(i);if(r.length<3)throw new Error("boundary must have at least 3 points");const e=_t(r),s=nt(e),l=s.width*s.height/500,u=n.maxArea??l,d=n.maxPoints??1e4,x=e.map(([y,_])=>new Pe.Point(y,_)),M=new Pe.SweepContext(x),p=wt(e,u,d);for(const[y,_]of p)M.addPoint(new Pe.Point(y,_));M.triangulate();const m=M.getTriangles(),h=new Map,j=[],b=y=>{const _=h.get(y);if(_!==void 0)return _;const L=j.length;return j.push([y.x,y.y]),h.set(y,L),L},R=[];for(const y of m){const _=y.getPoints(),L=b(_[0]),J=b(_[1]),A=b(_[2]);R.push([L,J,A])}const T=e.map(y=>Nt(j,y));return{vertices:j,faces:R,boundaryIndices:T}}function bt(i){if(i.length===0)return[];const n=i[0],r=i[i.length-1];return n[0]===r[0]&&n[1]===r[1]?i.slice(0,-1):i.slice()}function _t(i){return jt(i)<0?i.slice().reverse():i.slice()}function jt(i){let n=0;const r=i.length;for(let e=0;e<r;e++){const s=(e+1)%r;n+=i[e][0]*i[s][1]-i[s][0]*i[e][1]}return n}function nt(i){let n=1/0,r=1/0,e=-1/0,s=-1/0;for(const[d,x]of i)d<n&&(n=d),x<r&&(r=x),d>e&&(e=d),x>s&&(s=x);const l=Math.max(0,e-n),u=Math.max(0,s-r);return{minX:n,minY:r,maxX:e,maxY:s,width:l,height:u}}function Ct(i,n){const r=i[0],e=i[1];let s=!1;for(let l=0,u=n.length-1;l<n.length;u=l++){const d=n[l][0],x=n[l][1],M=n[u][0],p=n[u][1];x>e!=p>e&&r<(M-d)*(e-x)/(p-x+0)+d&&(s=!s)}return s}function wt(i,n,r){if(!Number.isFinite(n)||n<=0)return[];const e=nt(i);if(e.width===0||e.height===0)return[];const s=Math.max(2,Math.sqrt(4*n/Math.sqrt(3))),l=[];for(let u=e.minY+s/2;u<e.maxY;u+=s)for(let d=e.minX+s/2;d<e.maxX;d+=s){if(l.length>=r)return l;const x=[d,u];Ct(x,i)&&l.push(x)}return l}function Nt(i,n){let r=0,e=1/0;const s=n[0],l=n[1];for(let u=0;u<i.length;u++){const d=i[u][0]-s,x=i[u][1]-l,M=d*d+x*x;M<e&&(e=M,r=u)}return r}const Pt={iterations:5,cgMaxIterations:400,cgTolerance:1e-6,timeoutMs:6e4};let he=null,St=1;const Ee=new Map;function Mt(){if(he)return he;const i=new Worker(new URL("/my-site/python-apps/assets/arapMeshDeformWorker-BLC6KUpG.js",import.meta.url),{type:"module"});return i.onmessage=n=>{const r=n.data,e=Ee.get(r.id);e&&(Ee.delete(r.id),r.type==="error"?e.reject(new Error(r.message)):e.resolve(r))},i.onerror=n=>{console.error("arapMeshDeformWorker error",n)},he=i,he}function Et(){he&&he.terminate(),he=null}async function rt(i,n,r,e={}){const s={...Pt,...e};if(n.length===0)throw new Error("faces is empty");if(r.length<2)throw new Error("at least 2 constraints are required");const l=St++,u=Mt(),d=new Float64Array(i.length*2);for(let y=0;y<i.length;y++)d[y*2+0]=i[y][0],d[y*2+1]=i[y][1];const x=new Uint32Array(n.length*3);for(let y=0;y<n.length;y++)x[y*3+0]=n[y][0],x[y*3+1]=n[y][1],x[y*3+2]=n[y][2];const M=new Uint32Array(r.length),p=new Float64Array(r.length*2);for(let y=0;y<r.length;y++)M[y]=r[y].index,p[y*2+0]=r[y].position[0],p[y*2+1]=r[y].position[1];const m={id:l,type:"solve",vertices:d,faces:x,constraints:M,constraintPositions:p,options:{iterations:s.iterations,cgMaxIterations:s.cgMaxIterations,cgTolerance:s.cgTolerance}},h=new Promise((y,_)=>{Ee.set(l,{resolve:y,reject:_}),u.postMessage(m,[d.buffer,x.buffer,M.buffer,p.buffer])}),j=new Promise((y,_)=>{const L=window.setTimeout(()=>{Et(),_(new Error(`arapMeshDeform timed out after ${s.timeoutMs}ms`))},s.timeoutMs);h.finally(()=>window.clearTimeout(L))}),b=await Promise.race([h,j]);if(b.type!=="result")throw new Error("Unexpected worker response");const R=[],T=b.deformedVertices;for(let y=0;y<T.length/2;y++)R.push([T[y*2+0],T[y*2+1]]);return{deformedVertices:R,iterations:b.iterations}}async function it(i,n,r){const e=await xe(i,{simplifyRatio:r.contourSimplifyRatio}),s=await At(n,e,r),l=ke(s.xBest,{maxArea:r.triangulationMaxArea,maxPoints:r.triangulationMaxPoints}),u=It(l.boundaryIndices,s.escherizedBoundary),d=await rt(l.vertices,l.faces,u,{iterations:r.arapIterations,cgMaxIterations:r.arapCgMaxIterations,cgTolerance:r.arapCgTolerance});return{contour:e,python:s,triangulation:l,arap:d}}async function Tt(i,n,r){const{contour:e,python:s,triangulation:l,arap:u}=await it(i,n,r),d=await kt(n,{tilingPattern:r.tilingPattern,m:r.m,n:r.n,tranU:s.transU,tranV:s.transV,bestIdx:s.bestIdx,bestError:s.bestError,errors:s.errors,xBest:s.xBest,escherizedBoundary:s.escherizedBoundary,vertices:l.vertices,faces:l.faces,deformedVertices:u.deformedVertices,boundaryIndices:l.boundaryIndices});return{contour:e,python:s,triangulation:l,arap:u,matplotlibPngBase64:d}}async function At(i,n,r){const e=r.useResample?"True":"False",s=`
import numpy as np
from escherize_boundary import escherization

contour = np.array(${JSON.stringify(n.contour)}, dtype=float)
tran_u = np.array(${JSON.stringify(n.tranU)}, dtype=float)
tran_v = np.array(${JSON.stringify(n.tranV)}, dtype=float)

escherized_boundary, X_best, best_idx, best_error, errors = escherization(
    contour,
    ${JSON.stringify(r.tilingPattern)},
    int(${r.m}),
    int(${r.n}),
    ${e},
    tran_u,
    tran_v,
)

trans_u_out = None
trans_v_out = None
if ${JSON.stringify(r.tilingPattern)} == "P2":
    import p2
    trans_u_out, trans_v_out = p2.trans_uv(escherized_boundary, int(${r.m}), int(${r.n}))
elif ${JSON.stringify(r.tilingPattern)} == "P3":
    import p3
    trans_u_out, trans_v_out = p3.trans_uv(escherized_boundary, int(${r.m}))
else:
    trans_u_out = tran_u
    trans_v_out = tran_v
`;await i.runPythonAsync(s);const l=i.globals.get("escherized_boundary").toJs(),u=i.globals.get("X_best").toJs(),d=Le(i.globals.get("best_idx")),x=Le(i.globals.get("best_error")),M=i.globals.get("errors").toJs()??[],p=Ye(i.globals.get("trans_u_out")),m=Ye(i.globals.get("trans_v_out"));return{escherizedBoundary:l.map(h=>[h[0],h[1]]),xBest:u.map(h=>[h[0],h[1]]),bestIdx:d,bestError:x,errors:Array.from(M),transU:p,transV:m}}function It(i,n){if(i.length!==n.length)throw new Error(`boundary indices/positions mismatch: ${i.length} vs ${n.length}`);const r=new Map;for(let e=0;e<i.length;e++)r.set(i[e],n[e]);return Array.from(r.entries()).map(([e,s])=>({index:e,position:s}))}async function kt(i,n){const r=`
import numpy as np
from visualize_matplotlib import render_escherization_matplotlib_png_base64

X_best = np.array(${JSON.stringify(n.xBest)}, dtype=float)
errors = np.array(${JSON.stringify(n.errors)}, dtype=float)
escherized_boundary = np.array(${JSON.stringify(n.escherizedBoundary)}, dtype=float)
vertices = np.array(${JSON.stringify(n.vertices)}, dtype=float)
faces = np.array(${JSON.stringify(n.faces)}, dtype=int)
deformed_vertices = np.array(${JSON.stringify(n.deformedVertices)}, dtype=float)
boundary_indices = np.array(${JSON.stringify(n.boundaryIndices)}, dtype=int)
tran_u = np.array(${JSON.stringify(n.tranU)}, dtype=float)
tran_v = np.array(${JSON.stringify(n.tranV)}, dtype=float)

matplotlib_png_b64 = render_escherization_matplotlib_png_base64(
    X_best,
    int(${n.bestIdx}),
    errors,
    float(${n.bestError}),
    escherized_boundary,
    vertices,
    faces,
    deformed_vertices,
    boundary_indices,
    ${JSON.stringify(n.tilingPattern)},
    int(${n.m}),
    int(${n.n}),
    tran_u=tran_u,
    tran_v=tran_v,
    dpi=150,
)
`;await i.runPythonAsync(r);const e=i.globals.get("matplotlib_png_b64");return typeof e?.toJs=="function"?String(e.toJs()):String(e)}function Le(i){return i==null?NaN:typeof i=="number"?i:typeof i?.toJs=="function"?Number(i.toJs()):Number(i)}function Ye(i){if(i==null)return[0,0];if(typeof i?.toJs=="function"){const n=i.toJs();return[Number(n[0]??0),Number(n[1]??0)]}return Array.isArray(i)?[Number(i[0]??0),Number(i[1]??0)]:[0,0]}function Rt(){const i=f.useMemo(()=>["escherization/escherize_boundary.py","escherization/p1.py","escherization/p2.py","escherization/p3.py","escherization/tiling_condition.py","escherization/visualize_matplotlib.py"],[]),{pyodide:n,isReady:r,error:e}=Ze(i,{packages:["matplotlib"]}),[s,l]=f.useState(null),[u,d]=f.useState("P2"),[x,M]=f.useState(21),[p,m]=f.useState(21),[h,j]=f.useState(!0),[b,R]=f.useState(.008),[T]=f.useState(""),[y,_]=f.useState(4e3),[L,J]=f.useState(5),[A,E]=f.useState(400),[N,W]=f.useState(1e-6),[B,k]=f.useState(null),[q,Y]=f.useState("待機中"),[K,Z]=f.useState(null),[$,ee]=f.useState(!1),H=f.useMemo(()=>{const z=Number(T);return Number.isFinite(z)&&z>0?z:void 0},[T]),ie=f.useCallback(async()=>{if(s&&!(!n||!r)){ee(!0),Z(null),k(null);try{Y("画像読み込み...");const z=await me(s),ne={tilingPattern:u,m:x,n:p,useResample:h,contourSimplifyRatio:b,triangulationMaxArea:H,triangulationMaxPoints:y,arapIterations:L,arapCgMaxIterations:A,arapCgTolerance:N};Y("輪郭抽出→Pythonエッシャー化→メッシュ→ASAP→Matplotlib...");const G=await Tt(z,n,ne);k(G.matplotlibPngBase64),Y(`完了: contour=${G.contour.contour.length}, xBest=${G.python.xBest.length}, verts=${G.triangulation.vertices.length}, tris=${G.triangulation.faces.length}`)}catch(z){console.error("pipeline failed",z),Z(z instanceof Error?z.message:String(z)),Y("失敗")}finally{ee(!1)}}},[L,A,N,b,s,r,x,p,H,n,u,y,h]);return t.jsxs("section",{children:[t.jsx("h2",{children:"Matplotlib Debug Pipeline"}),t.jsx("p",{children:"Web実装（輪郭/メッシュ/ASAP）+ Python（escherize_boundary）で一連処理を実行し、Matplotlib結果を確認します。"}),t.jsxs("div",{className:"escher-controls",children:[t.jsxs("label",{className:"control",children:[t.jsx("span",{children:"画像ファイル"}),t.jsx("input",{type:"file",accept:"image/*",onChange:z=>l(z.target.files?.[0]??null)})]}),t.jsxs("div",{className:"controls-row",children:[t.jsxs("label",{className:"control",children:[t.jsx("span",{children:"tilingPattern"}),t.jsxs("select",{value:u,onChange:z=>d(z.target.value),children:[t.jsx("option",{value:"P2",children:"P2"}),t.jsx("option",{value:"P3",children:"P3"}),t.jsx("option",{value:"P1",children:"P1"})]})]}),t.jsxs("label",{className:"control",children:[t.jsx("span",{children:"m"}),t.jsx("input",{type:"number",step:"1",min:"3",value:x,onChange:z=>M(Number(z.target.value))})]}),t.jsxs("label",{className:"control",children:[t.jsx("span",{children:"n"}),t.jsx("input",{type:"number",step:"1",min:"3",value:p,onChange:z=>m(Number(z.target.value))})]}),t.jsxs("label",{className:"control",children:[t.jsx("span",{children:"resample"}),t.jsxs("select",{value:h?"1":"0",onChange:z=>j(z.target.value==="1"),children:[t.jsx("option",{value:"1",children:"true"}),t.jsx("option",{value:"0",children:"false"})]})]})]}),t.jsxs("div",{className:"controls-row",children:[t.jsxs("label",{className:"control",children:[t.jsx("span",{children:"contour simplifyRatio"}),t.jsx("input",{type:"number",step:"0.001",min:"0",value:b,onChange:z=>R(Number(z.target.value))})]}),t.jsxs("label",{className:"control",children:[t.jsx("span",{children:"tri maxPoints"}),t.jsx("input",{type:"number",step:"100",min:"0",value:y,onChange:z=>_(Number(z.target.value))})]})]}),t.jsxs("div",{className:"controls-row",children:[t.jsxs("label",{className:"control",children:[t.jsx("span",{children:"ASAP iters"}),t.jsx("input",{type:"number",step:"1",min:"1",value:L,onChange:z=>J(Number(z.target.value))})]}),t.jsxs("label",{className:"control",children:[t.jsx("span",{children:"CG iters"}),t.jsx("input",{type:"number",step:"50",min:"1",value:A,onChange:z=>E(Number(z.target.value))})]}),t.jsxs("label",{className:"control",children:[t.jsx("span",{children:"CG tol"}),t.jsx("input",{type:"number",step:"1e-6",min:"0",value:N,onChange:z=>W(Number(z.target.value))})]})]}),e&&t.jsxs("div",{className:"error",children:["Pyodideエラー: ",e]}),!e&&!r&&t.jsx("div",{className:"error",children:"Pyodideロード中..."}),K&&t.jsxs("div",{className:"error",children:["エラー: ",K]}),t.jsxs("div",{className:"controls-row",children:[t.jsx("button",{className:"run-button",onClick:ie,disabled:!s||!r||!n||$,children:$?"処理中...":"実行"}),t.jsxs("div",{className:"control",children:[t.jsx("span",{children:"status"}),t.jsx("input",{value:q,readOnly:!0})]})]})]}),B&&t.jsx("div",{className:"canvas-wrap",style:{marginTop:16},children:t.jsx("img",{alt:"matplotlib result",src:`data:image/png;base64,${B}`,style:{maxWidth:"100%",height:"auto",display:"block"}})})]})}function Wt(i,n){const r=i[0]-n[0],e=i[1]-n[1];return r*r+e*e}function qe(i,n){const r=i.getBoundingClientRect(),e=i.width/r.width,s=i.height/r.height,l=(n.clientX-r.left)*e,u=(n.clientY-r.top)*s;return[l,u]}function Ve(i,n,r,e,s){i.beginPath(),i.arc(n[0],n[1],r,0,Math.PI*2),i.fillStyle=e,i.fill(),i.lineWidth=2,i.strokeStyle=s,i.stroke()}function zt(){const[i,n]=f.useState(null),[r,e]=f.useState(.008),[s,l]=f.useState(""),[u,d]=f.useState(4e3),[x,M]=f.useState(5),[p,m]=f.useState(400),[h,j]=f.useState(1e-6),[b,R]=f.useState("draggable"),[T,y]=f.useState(null),[_,L]=f.useState(null),[J,A]=f.useState([]),[E,N]=f.useState(null),[W,B]=f.useState(null),[k,q]=f.useState(null),[Y,K]=f.useState(null),[Z,$]=f.useState(null),[ee,H]=f.useState(!1),ie=f.useRef(null),z=f.useRef(!1),ne=f.useRef(!1),G=f.useRef(null),ae=f.useMemo(()=>{const w=Number(s);return Number.isFinite(w)&&w>0?w:void 0},[s]),te=f.useMemo(()=>!_||E===null?null:_.vertices[E],[E,_]),c=f.useCallback((w,O,F,U,v)=>{const D=ie.current;if(!D)return;const P=D.getContext("2d");if(!P)return;D.width=w.imageData.width,D.height=w.imageData.height,P.putImageData(w.imageData,0,0),P.save(),P.globalAlpha=.55,P.strokeStyle="rgba(0, 102, 255, 1)",P.lineWidth=Math.max(1,Math.floor(Math.min(D.width,D.height)/700));for(const[re,se,de]of O.faces){const oe=F[re],le=F[se],pe=F[de];P.beginPath(),P.moveTo(oe[0],oe[1]),P.lineTo(le[0],le[1]),P.lineTo(pe[0],pe[1]),P.closePath(),P.stroke()}P.restore(),P.save(),P.globalAlpha=.85,P.strokeStyle="rgba(0,0,0,0.65)",P.lineWidth=Math.max(2,Math.floor(Math.min(D.width,D.height)/450));const X=w.contour;if(X.length>=2){P.beginPath(),P.moveTo(X[0][0],X[0][1]);for(let re=1;re<X.length;re++)P.lineTo(X[re][0],X[re][1]);P.closePath(),P.stroke()}P.restore();const Q=Math.max(4,Math.floor(Math.min(D.width,D.height)/180));U&&Ve(P,U,Q,"rgba(255, 220, 0, 0.9)","rgba(0,0,0,0.7)"),v&&Ve(P,v,Q,"rgba(255, 0, 160, 0.9)","rgba(0,0,0,0.7)")},[]),a=f.useCallback(w=>{if(!_||J.length===0)return null;let O=null,F=1/0;for(const D of J){const P=Wt(_.vertices[D],w);P<F&&(F=P,O=D)}const U=ie.current;if(!U)return O;const v=Math.max(10,Math.min(U.width,U.height)/40);return F<=v*v?O:null},[J,_]),o=f.useCallback(async w=>{if(!(!_||!Y||E===null||W===null)&&E!==W&&te){ne.current=!0;try{const O=await rt(_.vertices,_.faces,[{index:E,position:te},{index:W,position:w}],{iterations:x,cgMaxIterations:p,cgTolerance:h});K(O.deformedVertices),T&&c(T,_,O.deformedVertices,te,w)}finally{ne.current=!1}}},[x,p,h,Y,c,W,E,te,_,T]),g=f.useCallback(w=>{if(G.current=w,ne.current)return;const O=async()=>{const F=G.current;F&&(G.current=null,await o(F),G.current&&await O())};O()},[o]),C=f.useCallback(async()=>{if(i){H(!0),$(null),y(null),L(null),K(null),N(null),B(null),q(null),A([]);try{const w=await me(i),O=await xe(w,{simplifyRatio:r}),F=ke(O.contour,{maxArea:ae,maxPoints:u}),U=Array.from(new Set(F.boundaryIndices));if(U.length<2)throw new Error("boundary vertices not found");const v=U[0],D=U[Math.floor(U.length/2)],P=F.vertices[D];y(O),L(F),A(U),N(v),B(D),q(P),K(F.vertices),c(O,F,F.vertices,F.vertices[v],P)}catch(w){console.error("ARAP interactive test failed:",w),$(w instanceof Error?w.message:String(w))}finally{H(!1)}}},[c,i,ae,r,u]),S=f.useCallback(w=>{const O=ie.current;if(!O||!_||!Y)return;const F=qe(O,w),U=a(F);if(U===null)return;if(b==="fixed"){if(W!==null&&U===W)return;N(U),T&&k&&c(T,_,Y,_.vertices[U],k);return}if(E!==null&&U===E)return;B(U);const v=Y[U];q(v),T&&c(T,_,Y,te,v),z.current=!0},[Y,W,k,c,E,te,_,b,a,T]),I=f.useCallback(w=>{const O=ie.current;if(!O||!_||!T||!z.current||E===null||W===null||E===W)return;const F=qe(O,w);q(F),g(F)},[W,E,_,T,g]),V=f.useCallback(()=>{z.current=!1},[]);return t.jsxs("section",{children:[t.jsx("h2",{children:"ARAP (Interactive)"}),t.jsx("p",{children:"境界上の固定点1つ + ドラッグ点1つでメッシュをARAP変形（`arap-mesh-deform`実装を2D/Worker向けに移植）"}),t.jsxs("div",{className:"escher-controls",children:[t.jsxs("label",{className:"control",children:[t.jsx("span",{children:"画像ファイル"}),t.jsx("input",{type:"file",accept:"image/*",onChange:w=>n(w.target.files?.[0]??null)})]}),t.jsxs("div",{className:"controls-row",children:[t.jsxs("label",{className:"control",children:[t.jsx("span",{children:"simplifyRatio"}),t.jsx("input",{type:"number",step:"0.001",min:"0",value:r,onChange:w=>e(Number(w.target.value))})]}),t.jsxs("label",{className:"control",children:[t.jsx("span",{children:"tri maxArea (empty=auto)"}),t.jsx("input",{type:"number",step:"1",min:"0",value:s,onChange:w=>l(w.target.value)})]}),t.jsxs("label",{className:"control",children:[t.jsx("span",{children:"tri maxPoints"}),t.jsx("input",{type:"number",step:"100",min:"0",value:u,onChange:w=>d(Number(w.target.value))})]}),t.jsxs("label",{className:"control",children:[t.jsx("span",{children:"ARAP iters"}),t.jsx("input",{type:"number",step:"1",min:"1",value:x,onChange:w=>M(Number(w.target.value))})]}),t.jsxs("label",{className:"control",children:[t.jsx("span",{children:"CG iters"}),t.jsx("input",{type:"number",step:"50",min:"1",value:p,onChange:w=>m(Number(w.target.value))})]}),t.jsxs("label",{className:"control",children:[t.jsx("span",{children:"CG tol"}),t.jsx("input",{type:"number",step:"1e-6",min:"0",value:h,onChange:w=>j(Number(w.target.value))})]}),t.jsx("button",{className:"run-button",onClick:C,disabled:!i||ee,children:ee?"処理中...":"メッシュ生成"})]}),t.jsxs("div",{className:"controls-row",children:[t.jsxs("label",{className:"control",children:[t.jsx("span",{children:"ピックモード"}),t.jsxs("select",{value:b,onChange:w=>R(w.target.value),children:[t.jsx("option",{value:"draggable",children:"Draggable（クリックで選択→そのままドラッグ）"}),t.jsx("option",{value:"fixed",children:"Fixed（クリックで固定点を設定）"})]})]}),t.jsxs("div",{className:"control",children:[t.jsx("span",{children:"fixed index"}),t.jsx("input",{value:E??"",readOnly:!0})]}),t.jsxs("div",{className:"control",children:[t.jsx("span",{children:"draggable index"}),t.jsx("input",{value:W??"",readOnly:!0})]})]}),Z&&t.jsxs("div",{className:"error",children:["エラー: ",Z]})]}),t.jsxs("div",{className:"escher-output",children:[t.jsx("div",{className:"canvas-wrap",children:t.jsx("canvas",{ref:ie,onMouseDown:S,onMouseMove:I,onMouseUp:V,onMouseLeave:V})}),t.jsxs("div",{className:"stats",children:[t.jsx("h3",{children:"状態"}),!T||!_?t.jsx("p",{children:"「メッシュ生成」を押してください。"}):t.jsxs("dl",{children:[t.jsxs("div",{className:"kv",children:[t.jsx("dt",{children:"contour points"}),t.jsx("dd",{children:T.contour.length})]}),t.jsxs("div",{className:"kv",children:[t.jsx("dt",{children:"vertices"}),t.jsx("dd",{children:_.vertices.length})]}),t.jsxs("div",{className:"kv",children:[t.jsx("dt",{children:"triangles"}),t.jsx("dd",{children:_.faces.length})]}),t.jsxs("div",{className:"kv",children:[t.jsx("dt",{children:"boundary unique"}),t.jsx("dd",{children:J.length})]})]})]})]})]})}function Dt(i,n,r){return Math.abs((n[0]-i[0])*(r[1]-i[1])-(n[1]-i[1])*(r[0]-i[0]))}function Bt(){const[i,n]=f.useState(null),[r,e]=f.useState(.008),[s,l]=f.useState(""),[u,d]=f.useState(1e4),[x,M]=f.useState(9e4),[p,m]=f.useState(null),[h,j]=f.useState(null),[b,R]=f.useState(null),[T,y]=f.useState(!1),_=f.useRef(null),L=f.useMemo(()=>{const N=Number(s);return Number.isFinite(N)&&N>0?N:void 0},[s]),J=f.useCallback((N,W)=>{const B=_.current;if(!B)return;const k=B.getContext("2d");if(!k)return;B.width=N.imageData.width,B.height=N.imageData.height,k.putImageData(N.imageData,0,0),k.save(),k.lineWidth=Math.max(1,Math.floor(Math.min(B.width,B.height)/700)),k.globalAlpha=.45,k.strokeStyle="rgba(0, 102, 255, 1)";for(const[Y,K,Z]of W.faces){const $=W.vertices[Y],ee=W.vertices[K],H=W.vertices[Z];k.beginPath(),k.moveTo($[0],$[1]),k.lineTo(ee[0],ee[1]),k.lineTo(H[0],H[1]),k.closePath(),k.stroke()}k.globalAlpha=.9,k.strokeStyle="rgba(255, 0, 0, 1)",k.lineWidth=Math.max(2,Math.floor(Math.min(B.width,B.height)/450));const q=N.contour;if(q.length>=2){k.beginPath(),k.moveTo(q[0][0],q[0][1]);for(let Y=1;Y<q.length;Y++)k.lineTo(q[Y][0],q[Y][1]);k.closePath(),k.stroke()}k.restore()},[]),A=f.useCallback(async()=>{if(i){y(!0),R(null),m(null),j(null);try{const N=await me(i),W=await xe(N,{simplifyRatio:r,timeoutMs:x}),B=ke(W.contour,{maxArea:L,maxPoints:u});m(W),j(B),J(W,B)}catch(N){console.error("Triangulation test failed:",N),R(N instanceof Error?N.message:String(N))}finally{y(!1)}}},[J,i,u,L,r,x]),E=f.useMemo(()=>{if(!h)return null;let N=1/0,W=-1/0,B=0;for(const[q,Y,K]of h.faces){const $=Dt(h.vertices[q],h.vertices[Y],h.vertices[K])/2;$<N&&(N=$),$>W&&(W=$),B+=$}const k=h.faces.length?B/h.faces.length:0;return{vertices:h.vertices.length,faces:h.faces.length,boundary:h.boundaryIndices.length,interior:h.vertices.length-h.boundaryIndices.length,minArea:Number.isFinite(N)?N:0,maxArea:Number.isFinite(W)?W:0,meanArea:k}},[h]);return t.jsxs("section",{children:[t.jsx("h2",{children:"triangulate_boundary (Test)"}),t.jsx("p",{children:"輪郭点から三角形分割（poly2tri + Steiner点追加で面積制御を近似）"}),t.jsxs("div",{className:"escher-controls",children:[t.jsxs("label",{className:"control",children:[t.jsx("span",{children:"画像ファイル"}),t.jsx("input",{type:"file",accept:"image/*",onChange:N=>n(N.target.files?.[0]??null)})]}),t.jsxs("div",{className:"controls-row",children:[t.jsxs("label",{className:"control",children:[t.jsx("span",{children:"simplifyRatio"}),t.jsx("input",{type:"number",step:"0.001",min:"0",value:r,onChange:N=>e(Number(N.target.value))})]}),t.jsxs("label",{className:"control",children:[t.jsx("span",{children:"maxArea (empty=auto)"}),t.jsx("input",{type:"number",step:"1",min:"0",value:s,onChange:N=>l(N.target.value)})]}),t.jsxs("label",{className:"control",children:[t.jsx("span",{children:"maxPoints"}),t.jsx("input",{type:"number",step:"100",min:"0",value:u,onChange:N=>d(Number(N.target.value))})]}),t.jsxs("label",{className:"control",children:[t.jsx("span",{children:"timeout (ms)"}),t.jsx("input",{type:"number",step:"1000",min:"1000",value:x,onChange:N=>M(Number(N.target.value))})]}),t.jsx("button",{className:"run-button",onClick:A,disabled:!i||T,children:T?"処理中...":"実行"})]}),b&&t.jsxs("div",{className:"error",children:["エラー: ",b]})]}),t.jsxs("div",{className:"escher-output",children:[t.jsx("div",{className:"canvas-wrap",children:t.jsx("canvas",{ref:_})}),t.jsxs("div",{className:"stats",children:[t.jsx("h3",{children:"結果"}),!p||!h||!E?t.jsx("p",{children:"画像を選んで「実行」を押してください。"}):t.jsxs("dl",{children:[t.jsxs("div",{className:"kv",children:[t.jsx("dt",{children:"contour points"}),t.jsx("dd",{children:p.contour.length})]}),t.jsxs("div",{className:"kv",children:[t.jsx("dt",{children:"vertices"}),t.jsx("dd",{children:E.vertices})]}),t.jsxs("div",{className:"kv",children:[t.jsx("dt",{children:"triangles"}),t.jsx("dd",{children:E.faces})]}),t.jsxs("div",{className:"kv",children:[t.jsx("dt",{children:"boundary"}),t.jsxs("dd",{children:[E.boundary," / interior ",E.interior]})]}),t.jsxs("div",{className:"kv",children:[t.jsx("dt",{children:"area (min/mean/max)"}),t.jsxs("dd",{children:[E.minArea.toFixed(2)," / ",E.meanArea.toFixed(2)," / ",E.maxArea.toFixed(2)]})]})]})]})]})]})}function $t(i){const{tilingPattern:n,m:r,n:e,nx:s,ny:l,deformedVertices:u,escherizedBoundary:d,transU:x,transV:M}=i,p=n==="P2"?Xt(u,d,r,e):n==="P3"?Lt(u,d,r):[u],m=[],h=n==="P2"?Math.max(1,Math.floor(s/2)):Math.max(1,Math.floor(s)),j=n==="P2"?Math.max(1,Math.floor(l/2)):Math.max(1,Math.floor(l));for(let b=0;b<h;b++)for(let R=0;R<j;R++){const T=[x[0]*b+M[0]*R,x[1]*b+M[1]*R];for(const y of p)m.push(Yt(y,T))}return m}function Ft({ctx:i,image:n,sourceVertices:r,faces:e,tiles:s,width:l,height:u,view:d}){i.setTransform(1,0,0,1,0,0),i.clearRect(0,0,l,u),Ot(i,l,u);const x=Ut(s),M=Math.max(1e-6,x.maxX-x.minX),p=Math.max(1e-6,x.maxY-x.minY),m=24,h=Math.max(1,l-m*2),j=Math.max(1,u-m*2),b=Math.max(h/M,j/p),R=d?.zoom??1,T=l/2,y=u/2,_=(x.minX+x.maxX)/2,L=(x.minY+x.maxY)/2,J=T-_*b,A=y-L*b,E=b*R,N=J*R+(d?.panX??0),W=A*R+(d?.panY??0),B=k=>[k[0]*E+N,k[1]*E+W];i.imageSmoothingEnabled=!0;for(const k of s)for(const q of e){const Y=r[q[0]],K=r[q[1]],Z=r[q[2]],$=B(k[q[0]]),ee=B(k[q[1]]),H=B(k[q[2]]);Ht(i,n,Y,K,Z,$,ee,H)}}function Ot(i,n,r){const e=i.createLinearGradient(0,0,n,r);e.addColorStop(0,"#f8fafc"),e.addColorStop(1,"#e2e8f0"),i.fillStyle=e,i.fillRect(0,0,n,r),i.strokeStyle="rgba(15, 23, 42, 0.08)",i.lineWidth=1;const s=48;for(let l=0;l<=n;l+=s)i.beginPath(),i.moveTo(l,0),i.lineTo(l,r),i.stroke();for(let l=0;l<=r;l+=s)i.beginPath(),i.moveTo(0,l),i.lineTo(n,l),i.stroke()}function Ut(i){let n=1/0,r=1/0,e=-1/0,s=-1/0;for(const l of i)for(const[u,d]of l)u<n&&(n=u),d<r&&(r=d),u>e&&(e=u),d>s&&(s=d);return Number.isFinite(n)||(n=0,r=0,e=1,s=1),{minX:n,minY:r,maxX:e,maxY:s}}function Xt(i,n,r,e){const{center0:s,center1:l,center2:u}=Vt(r,e),d=n[l],x=n[u],M=n[s],p=Math.PI,m=fe(i,d,p),h=fe(i,x,p),j=qt(M,d,p),b=fe(m,j,p);return[i,m,h,b]}function Lt(i,n,r){const e=Jt(r),s=fe(i,n[e[0]],-2*Math.PI/3),l=fe(i,n[e[1]],2*Math.PI/3);return[i,s,l]}function Yt(i,n){return i.map(([r,e])=>[r+n[0],e+n[1]])}function fe(i,n,r){const e=Math.cos(r),s=Math.sin(r),l=n[0],u=n[1];return i.map(([d,x])=>{const M=d-l,p=x-u;return[e*M-s*p+l,s*M+e*p+u]})}function qt(i,n,r){const e=Math.cos(r),s=Math.sin(r),l=i[0]-n[0],u=i[1]-n[1];return[e*l-s*u+n[0],s*l+e*u+n[1]]}function Vt(i,n){const r=Array.from({length:i},(u,d)=>d),e=Array.from({length:n},(u,d)=>i-1+d),s=Array.from({length:i},(u,d)=>i+n-2+d),l=Array.from({length:n},(u,d)=>2*i+n-3+d);return l[l.length-1]=0,{center0:r[Math.floor(r.length/2)],center1:e[Math.floor(e.length/2)],center2:s[Math.floor(s.length/2)],center3:l[Math.floor(l.length/2)]}}function Jt(i){const n=Array.from({length:i},(u,d)=>d);let r=i-1;r=r+i-1;const e=Array.from({length:i},(u,d)=>r+d);r=r+i-1,r=r+i-1;const s=Array.from({length:i},(u,d)=>r+d);r=r+i-1;const l=Array.from({length:i},(u,d)=>r+d);return l[l.length-1]=0,[n[n.length-1],e[e.length-1],s[s.length-1]]}function Ht(i,n,r,e,s,l,u,d){const x=r[0]*(e[1]-s[1])+e[0]*(s[1]-r[1])+s[0]*(r[1]-e[1]);if(Math.abs(x)<1e-8)return;const M=(l[0]*(e[1]-s[1])+u[0]*(s[1]-r[1])+d[0]*(r[1]-e[1]))/x,p=(l[1]*(e[1]-s[1])+u[1]*(s[1]-r[1])+d[1]*(r[1]-e[1]))/x,m=(l[0]*(s[0]-e[0])+u[0]*(r[0]-s[0])+d[0]*(e[0]-r[0]))/x,h=(l[1]*(s[0]-e[0])+u[1]*(r[0]-s[0])+d[1]*(e[0]-r[0]))/x,j=(l[0]*(e[0]*s[1]-s[0]*e[1])+u[0]*(s[0]*r[1]-r[0]*s[1])+d[0]*(r[0]*e[1]-e[0]*r[1]))/x,b=(l[1]*(e[0]*s[1]-s[0]*e[1])+u[1]*(s[0]*r[1]-r[0]*s[1])+d[1]*(r[0]*e[1]-e[0]*r[1]))/x;i.save(),i.beginPath(),i.moveTo(l[0],l[1]),i.lineTo(u[0],u[1]),i.lineTo(d[0],d[1]),i.closePath(),i.clip(),i.setTransform(M,p,m,h,j,b),i.drawImage(n,0,0),i.restore()}const Je="/my-site/python-apps/",He=[{value:"yumekawa_animal_usagi.png",label:"ゆめかわ うさぎ"},{value:"asobu_cat_shadow.png",label:"遊ぶ ねこ"},{value:"eto_uma_banzai.png",label:"干支 うま"},{value:"eto_ushi_banzai.png",label:"干支 うし"},{value:"point_katen_woman.png",label:"ポイント 女性"},{value:"seiji_souridaijin_bg3.png",label:"政治 総理大臣"}];function Ge(){const i=f.useMemo(()=>["escherization/escherize_boundary.py","escherization/p1.py","escherization/p2.py","escherization/p3.py","escherization/tiling_condition.py"],[]),{pyodide:n,isReady:r,error:e}=Ze(i),s=f.useRef(null),l=f.useRef(null),[u,d]=f.useState("sample"),[x,M]=f.useState(null),[p,m]=f.useState(He[0].value),[h,j]=f.useState("P3"),[b,R]=f.useState(21),[T,y]=f.useState(21),[_,L]=f.useState(5),[J,A]=f.useState(5),[E,N]=f.useState(.005),[W]=f.useState(""),[B,k]=f.useState("待機中"),[q,Y]=f.useState(null),[K,Z]=f.useState(!1),[$,ee]=f.useState(null),[H,ie]=f.useState(null),[z,ne]=f.useState(null),[G,ae]=f.useState({width:900,height:600}),[te,c]=f.useState({zoom:1,panX:0,panY:0}),a=f.useRef({isDragging:!1,lastX:0,lastY:0}),o=f.useRef(null),g=f.useRef(te);f.useEffect(()=>{h==="P2"&&(b%2===0&&R(v=>v+1),T%2===0&&y(v=>v+1))},[b,T,h]),f.useEffect(()=>{const v=l.current;if(!v)return;const D=()=>{const X=Math.max(320,v.clientWidth),Q=Math.max(420,v.clientHeight||640);ae({width:X,height:Q})};D();const P=new ResizeObserver(D);return P.observe(v),()=>P.disconnect()},[]),f.useEffect(()=>()=>{H?.close()},[H]),f.useEffect(()=>{if(u==="sample"){ne(`${Je}escherization/sample_images/${p}`);return}if(!x){ne(null);return}const v=URL.createObjectURL(x);return ne(v),()=>URL.revokeObjectURL(v)},[u,x,p]);const C=f.useMemo(()=>{const v=Number(W);return Number.isFinite(v)&&v>0?v:void 0},[W]),S=f.useMemo(()=>h!=="P2"?{m:b,n:T}:{m:b%2===0?b+1:b,n:T%2===0?T+1:T},[b,T,h]),I=f.useCallback(async(v,D,P)=>{if(!(!n||!r)){Z(!0),Y(null),ee(null);try{ie(v);const X={tilingPattern:h,m:S.m,n:S.n,useResample:!0,contourSimplifyRatio:E,triangulationMaxArea:C,triangulationMaxPoints:4e3,arapIterations:8,arapCgMaxIterations:300,arapCgTolerance:1e-6};k("輪郭抽出→Pythonエッシャー化→メッシュ→ASAP...");const Q=await it(D,n,X);ee(Q),o.current=`${h}:${S.m}:${S.n}:${E}:${P}`,k(`完了: verts=${Q.triangulation.vertices.length}, tris=${Q.triangulation.faces.length}`)}catch(X){console.error("main pipeline failed",X),Y(X instanceof Error?X.message:String(X)),k("失敗")}finally{Z(!1)}}},[E,r,S.m,S.n,C,n,h]),V=f.useCallback(async()=>{if(!n||!r)return;if(k("画像読み込み..."),u==="file"){if(!x)return;const Q=await createImageBitmap(x),re=Se(Q);await I(Q,re,"file");return}const v=await fetch(`${Je}escherization/sample_images/${p}`);if(!v.ok)throw new Error(`サンプル画像の取得に失敗しました: ${v.status} ${v.statusText}`);const D=await v.blob(),P=await createImageBitmap(D),X=Se(P);await I(P,X,`sample:${p}`)},[u,x,r,n,I,p]);f.useEffect(()=>{if(!n||!r||K||u==="file"&&!x)return;const v=u==="file"?"file":`sample:${p}`;`${h}:${S.m}:${S.n}:${E}:${v}`!==o.current&&V()},[u,E,x,r,K,S.m,S.n,n,V,p,h]),f.useEffect(()=>{g.current=te},[te]),f.useEffect(()=>{const v=s.current;if(!v)return;const D=P=>{P.preventDefault();const X=v.getBoundingClientRect(),Q=P.clientX-X.left,re=P.clientY-X.top,se=g.current,de=Math.exp(-P.deltaY*.0015),oe=Math.min(6,Math.max(.2,se.zoom*de)),le=oe/se.zoom,pe=Q-(Q-se.panX)*le,st=re-(re-se.panY)*le;c({zoom:oe,panX:pe,panY:st})};return v.addEventListener("wheel",D,{passive:!1}),()=>v.removeEventListener("wheel",D)},[]),f.useEffect(()=>{if(!$||!H)return;const v=s.current;if(!v)return;v.width=G.width,v.height=G.height;const D=v.getContext("2d");if(!D)return;const P=$t({tilingPattern:h,m:S.m,n:S.n,nx:_,ny:J,deformedVertices:$.arap.deformedVertices,escherizedBoundary:$.python.escherizedBoundary,transU:$.python.transU,transV:$.python.transV});Ft({ctx:D,image:H,sourceVertices:$.triangulation.vertices,faces:$.triangulation.faces,tiles:P,width:G.width,height:G.height,view:te})},[G.height,G.width,_,J,S.m,S.n,$,H,h,te]);const w=t.jsx("p",{className:"escher-help",children:"P1は平行移動のみ、P2は180度回転＋平行移動（辺U/辺Vの頂点数は奇数に自動補正）、P3は120度回転＋平行移動（1辺の頂点数のみ使用）です。"}),O=h==="P2"?4:h==="P3"?3:1,F=h==="P2"?Math.max(1,Math.floor(_/2)):Math.max(1,Math.floor(_)),U=h==="P2"?Math.max(1,Math.floor(J/2)):Math.max(1,Math.floor(J));return t.jsxs("section",{className:"escher-main-page",children:[t.jsx("header",{className:"escher-main-hero",children:t.jsxs("div",{children:[t.jsx("h2",{children:"Escherization Tiling（エッシャー化）"}),t.jsx("p",{children:"画像→輪郭→エッシャー化→メッシュ変形をWebで実行し、タイリング表示します。"})]})}),t.jsxs("div",{className:"escher-main-grid",children:[t.jsxs("div",{className:"escher-panel-stack",children:[t.jsxs("div",{className:"escher-panel",children:[t.jsx("h3",{children:"サンプル画像"}),t.jsxs("label",{className:"control",children:[t.jsx("span",{children:"サンプル選択"}),t.jsx("select",{value:p,onChange:v=>{m(v.target.value),d("sample")},children:He.map(v=>t.jsx("option",{value:v.value,children:v.label},v.value))})]})]}),t.jsxs("div",{className:"escher-panel",children:[t.jsx("h3",{children:"入力画像"}),t.jsxs("label",{className:"control",children:[t.jsx("span",{children:"画像ファイル"}),t.jsx("input",{type:"file",accept:"image/*",onChange:v=>{const D=v.target.files?.[0]??null;M(D),d("file")}})]})]}),t.jsxs("div",{className:"escher-panel",children:[t.jsx("h3",{children:"タイリング設定"}),t.jsxs("label",{className:"control",children:[t.jsx("span",{children:"タイリングパターン"}),t.jsxs("select",{value:h,onChange:v=>j(v.target.value),children:[t.jsx("option",{value:"P2",children:"P2"}),t.jsx("option",{value:"P3",children:"P3"}),t.jsx("option",{value:"P1",children:"P1"})]})]}),w,t.jsx("div",{className:"controls-row",children:h==="P3"?t.jsxs("label",{className:"control",children:[t.jsx("span",{children:"1辺の頂点数"}),t.jsx("input",{type:"number",step:"1",min:"3",value:b,onChange:v=>R(Number(v.target.value))})]}):t.jsxs(t.Fragment,{children:[t.jsxs("label",{className:"control",children:[t.jsx("span",{children:"辺Uの頂点数"}),t.jsx("input",{type:"number",step:"1",min:"3",value:b,onChange:v=>R(Number(v.target.value))})]}),t.jsxs("label",{className:"control",children:[t.jsx("span",{children:"辺Vの頂点数"}),t.jsx("input",{type:"number",step:"1",min:"3",value:T,onChange:v=>y(Number(v.target.value))})]})]})}),t.jsxs("div",{className:"controls-row",children:[t.jsxs("label",{className:"control",children:[t.jsx("span",{children:"タイル数 nx"}),t.jsx("input",{type:"number",step:"1",min:"1",value:_,onChange:v=>L(Number(v.target.value))})]}),t.jsxs("label",{className:"control",children:[t.jsx("span",{children:"タイル数 ny"}),t.jsx("input",{type:"number",step:"1",min:"1",value:J,onChange:v=>A(Number(v.target.value))})]})]})]}),t.jsxs("div",{className:"escher-panel",children:[t.jsx("h3",{children:"輪郭 & メッシュ"}),t.jsx("div",{className:"controls-row",children:t.jsxs("label",{className:"control",children:[t.jsx("span",{children:"輪郭の細かさ"}),t.jsxs("select",{value:String(E),onChange:v=>N(Number(v.target.value)),children:[t.jsx("option",{value:"0.001",children:"細かい (0.001)"}),t.jsx("option",{value:"0.005",children:"中 (0.005)"}),t.jsx("option",{value:"0.01",children:"荒い (0.01)"})]})]})})]}),e&&t.jsxs("div",{className:"error",children:["Pyodideエラー: ",e]}),!e&&!r&&t.jsx("div",{className:"error",children:"Pyodideロード中..."}),q&&t.jsxs("div",{className:"error",children:["エラー: ",q]}),t.jsxs("div",{className:"escher-panel",children:[t.jsx("h3",{children:"実行ステータス"}),t.jsxs("div",{className:"control",children:[t.jsx("span",{children:"status"}),t.jsx("input",{value:B,readOnly:!0})]}),h==="P2"&&t.jsx("p",{className:"escher-help",children:"P2は奇数が必要なため、偶数は+1して自動補正します。"})]})]}),t.jsxs("div",{className:"escher-tiling-panel",children:[z&&t.jsx("div",{className:"tiling-hud",children:t.jsx("img",{src:z,alt:"エッシャー化前の画像"})}),t.jsxs("div",{className:"escher-tiling-header",children:[t.jsxs("div",{children:[t.jsx("h3",{children:"タイリング表示"}),t.jsx("p",{children:"右側キャンバスにエッシャー化結果を敷き詰めます。"})]}),$&&t.jsxs("div",{className:"tiling-stats",children:[t.jsxs("span",{children:["verts: ",$.triangulation.vertices.length]}),t.jsxs("span",{children:["tris: ",$.triangulation.faces.length]}),t.jsxs("span",{children:["tiles: ",F*U*O]})]})]}),t.jsxs("div",{ref:l,className:"tiling-canvas-wrap",children:[t.jsx("canvas",{ref:s,className:"tiling-canvas",onPointerDown:v=>{a.current={isDragging:!0,lastX:v.clientX,lastY:v.clientY},v.currentTarget.setPointerCapture(v.pointerId)},onPointerMove:v=>{if(!a.current.isDragging)return;const D=v.clientX-a.current.lastX,P=v.clientY-a.current.lastY;a.current.lastX=v.clientX,a.current.lastY=v.clientY,c(X=>({...X,panX:X.panX+D,panY:X.panY+P}))},onPointerUp:v=>{a.current.isDragging=!1,v.currentTarget.releasePointerCapture(v.pointerId)},onPointerLeave:()=>{a.current.isDragging=!1}}),!$&&t.jsx("div",{className:"tiling-empty",children:"画像を選択して「エッシャー化を実行」を押してください。"})]})]})]})]})}function Ke(i){const n=i.replace(/^#/,"");return n==="escherization-main"?"escherization-main":n==="contour-prep-test"?"contour-prep-test":n==="triangulation-test"?"triangulation-test":n==="arap-interactive-test"?"arap-interactive-test":n==="escherization-pipeline"?"escherization-pipeline":"home"}function Gt(){const[i,n]=f.useState(()=>Ke(window.location.hash));return f.useEffect(()=>{const r=()=>n(Ke(window.location.hash));return window.addEventListener("hashchange",r),()=>window.removeEventListener("hashchange",r)},[]),t.jsx("div",{className:"escher-shell",children:t.jsx("div",{className:"escher-layout",children:t.jsxs("main",{className:"escher-main",children:[i==="escherization-main"&&t.jsx(Ge,{}),i==="home"&&t.jsx(Ge,{}),i==="escherization-pipeline"&&t.jsx(Rt,{}),i==="contour-prep-test"&&t.jsx(ft,{}),i==="triangulation-test"&&t.jsx(Bt,{}),i==="arap-interactive-test"&&t.jsx(zt,{})]})})})}at.createRoot(document.getElementById("root")).render(t.jsx(f.StrictMode,{children:t.jsx(Gt,{})}));
